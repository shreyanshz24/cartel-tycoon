<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartel Tycoon: Grand Strategy</title>
  <style>
    :root {
      --main-green: #00ff00;
      --main-red: #ff0000;
      --dark-bg: #0a0a0a;
      --card-bg: rgba(0, 20, 0, 0.7);
      --border-color: #003300;
      --player-color: #0077ff;
      --ai1-color: #ff7700;
      --ai2-color: #ff00ff;
      --ai3-color: #ffff00;
      --neutral-color: #555;
    }

    body {
      font-family: 'Courier New', monospace;
      background: var(--dark-bg);
      color: var(--main-green);
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .container {
      display: none;
      padding: 15px;
      max-width: 1600px;
      margin: 0 auto;
      text-align: left;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .header h1 {
      font-size: 2rem;
      color: var(--main-red);
      text-shadow: 0 0 15px var(--main-red);
      margin: 0;
    }

    .top-stats-bar {
      display: flex;
      gap: 20px;
      background: var(--card-bg);
      padding: 5px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 15px;
      height: calc(100vh - 100px);
    }

    .card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 255, 0, 0.4);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    h2 {
      border-bottom: 1px solid var(--main-green);
      padding-bottom: 4px;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }

    h3 {
      font-size: 1rem;
      margin: 10px 0 5px 0;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 3px;
    }

    p {
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 4px 0;
    }

    button {
      width: 100%;
      padding: 8px 10px;
      margin: 4px 0;
      background: var(--main-red);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      box-sizing: border-box;
      font-size: 0.9rem;
    }
    
    button:disabled {
        background: #555;
        cursor: not-allowed;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 10px;
    }

    .tab-link {
      background: none;
      border-radius: 6px 6px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      color: var(--main-green);
      opacity: 0.6;
      margin: 0 2px;
      flex-grow: 1;
      padding: 8px;
      font-size: 0.9rem;
    }

    .tab-link.active {
      background: var(--card-bg);
      border-color: var(--border-color);
      opacity: 1;
    }

    .tab-content {
      display: none;
      flex-grow: 1;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    .item-list {
      overflow-y: auto;
      height: 100%;
    }

    .list-item {
      border-top: 1px solid var(--border-color);
      padding: 8px 0;
      margin-top: 8px;
    }

    #map-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
    }

    .territory {
        height: 60px;
        border: 2px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .territory:hover {
        transform: scale(1.05);
        border-color: var(--main-green);
    }
    .player-controlled { background-color: var(--player-color); }
    .ai-1-controlled { background-color: var(--ai1-color); }
    .ai-2-controlled { background-color: var(--ai2-color); }
    .ai-3-controlled { background-color: var(--ai3-color); }
    .neutral-controlled { background-color: var(--neutral-color); }
    .assign-mode { border: 3px dashed yellow !important; }

    /* --- NEW: Music Player Styles --- */
    #music-player {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card-bg);
      padding: 5px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    #song-title {
      font-size: 0.9rem;
      width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #music-player button {
      width: 40px;
      padding: 5px;
    }

    #youtube-player-container {
      display: none;
    }

    /* Hide the actual YouTube iframe */

    #menu {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      color: #f00;
      font-size: 3rem;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }

    #pauseBtn {
      width: 100px;
      background-color: #ffae00;
    }

    #pauseOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: #ffae00;
      font-size: 5rem;
      text-shadow: 0 0 15px #ffae00;
      justify-content: center;
      align-items: center;
      z-index: 999;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="menu">
    <h1>Cartel Tycoon</h1>
    <input type="text" id="playerName" placeholder="Enter Your Name"
      style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
    <div id="singlePlayerOptions">
      <label for="aiCount" style="font-size: 1.5rem; color: #0f0;">AI Opponents (1-3):</label>
      <input type="number" id="aiCount" value="2" min="1" max="3"
        style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
    </div>
    <button id="startGameBtn" style="width: 300px;">Single Player</button>
  </div>

  <div id="game" class="container">
    <header class="header">
      <h1>Cartel Tycoon</h1>
      <div id="music-player">
        <button onclick="prevSong()">⏮</button>
        <span id="song-title">Loading Music...</span>
        <button onclick="nextSong()">⏭</button>
      </div>
      <div class="top-stats-bar" id="top-stats"></div>
      <button id="pauseBtn" onclick="togglePause()">Pause</button>
    </header>
    <main>
      <div class="card" id="operations"></div>
      <div class="card" id="center-panel"></div>
      <div class="card" id="personnel-inventory"></div>
    </main>
  </div>

  <div id="notifications"
    style="position:fixed;top:20px;right:20px;width:300px;z-index:1001;font-weight:bold;text-align:right;"></div>
  <div id="gameOverScreen"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);color:#0f0;font-size:3rem;justify-content:center;align-items:center;flex-direction:column;z-index:1000;">
    <h2 id="gameOverText"></h2><button onclick="location.reload()">Start Over</button>
  </div>
  <div id="pauseOverlay" onclick="togglePause()">PAUSED</div>
  <div id="event-modal"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center;">
    <div class="modal-content" id="event-content"
      style="width:500px;background:#0a0a0a;border:2px solid #f00;padding:20px;text-align:center;box-shadow:0 0 30px #f00;">
    </div>
  </div>
  <div id="territory-modal"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center;">
    <div class="modal-content" id="territory-modal-content"
      style="width:500px;background:#0a0a0a;border:2px solid #0f0;padding:20px;text-align:center;"></div>
  </div>
  <div id="youtube-player-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        
    // =================================================================================
    // SECTION 1: CORE GAME SETUP & STATE
    // =================================================================================
    let playerName = "";
    let gameData = {};
    let gameLoopInterval = null;
    let isPaused = false;
    let gameMode = 'single';
    let currentActiveTab = 'map-panel';
    let currentActiveSubTab = 'lieutenants-subpanel';
    let isAssigningLieutenant = -1;
    let ytPlayer;

    // Make functions globally accessible for HTML onclicks
    window.startGame = startGame;
    window.togglePause = togglePause;
    window.prevSong = prevSong;
    window.nextSong = nextSong;
    window.handleButtonClick = handleButtonClick;
    window.showTab = showTab;
    window.showSubTab = showSubTab;
    window.upgradeLab = upgradeLab;
    window.upgradeWorkshop = upgradeWorkshop;
    window.manufactureArms = manufactureArms;
    window.sellArms = sellArms;
    window.fightBack = fightBack;
    window.hirePersonnel = hirePersonnel;
    window.attackTerritory = attackTerritory;
    window.assignLieutenant = assignLieutenant;
    window.proposeDeal = proposeDeal;
    window.startResearch = startResearch;
    window.sendSpyMission = sendSpyMission;
    window.buyProperty = buyProperty;
    window.showMainMenu = showMainMenu;
    window.startNewGame = startNewGame;
    window.loadGame = loadGame;
    window.showCredits = showCredits;
    window.createCustomDrug = createCustomDrug;

    document.getElementById('startGameBtn').addEventListener('click', () => startGame('single'));

    document.addEventListener("keydown", function(e) {
        if (!gameData || Object.keys(gameData).length === 0) return; // Cheats only work once game starts
        if (e.key === "1") { gameData.money += 100000; showNotification("Cheat: +100k Dirty", "lightgreen"); updateUI(); }
        if (e.key === "2") { gameData.whiteMoney += 100000; showNotification("Cheat: +100k Clean", "lightgreen"); updateUI(); }
        if (e.key === "3") { gameData.personnel.soldiers += 10; showNotification("Cheat: +10 Soldiers", "lightgreen"); updateUI(); }
        if (e.key === "4") { gameData.heat = 0; showNotification("Cheat: Heat Reset", "lightblue"); updateUI(); }
    });

    function resetGameData(aiCount = 2) {
      gameData = {
        money: 7500, whiteMoney: 0, heat: 0,
        inventory: { weed: 10, meth: 0, coke: 0, heroin: 0, fentanyl: 0, chemicals: 0 },
        armsStock: { handgun: 0, smg: 0, rifle: 0 },
        labLevel: 0, armsTier: 0, currentDrug: "weed",
        personnel: { producers: 0, dealers: 0, soldiers: 0, spies: 0 },
        lieutenants: [],
        properties: [],
        personnelLoyalty: 75,
        territories: [],
        aiPlayers: [],
        research: {
          logistics1: { name: 'Faster Couriers', desc: '+10% Dealer efficiency.', cost: 10000, time: 60, progress: 0, unlocked: false, requires: null },
          logistics2: { name: 'Bulk Chemicals', desc: 'Buy Chemicals in larger, cheaper batches.', cost: 50000, time: 120, progress: 0, unlocked: false, requires: 'logistics1' },
          military1: { name: 'Body Armor', desc: '+10% Soldier defense.', cost: 25000, time: 90, progress: 0, unlocked: false, requires: null },
          military2: { name: 'Assault Rifles', desc: '+15% Soldier attack power.', cost: 100000, time: 180, progress: 0, unlocked: false, requires: 'military1' },
          laundering1: { name: 'Shell Corps', desc: 'Lieutenants take a smaller cut.', cost: 75000, time: 150, progress: 0, unlocked: false, requires: null },
        },
        researchInProgress: null,
        victory: {
          domination: { current: 0, required: 15 },
          economic: { current: 0, required: 20000000 },
          status: 'Ongoing'
        },
        gangs: [
            { name: "Local Thugs", drug: "weed", strength: 1 },
            { name: "Street Gangs", drug: "meth", strength: 2 },
            { name: "Big City Gangs", drug: "coke", strength: 3 },
            { name: "Cartel", drug: "heroin", strength: 4 },
            { name: "Super Cartel", drug: "fentanyl", strength: 5 }
        ],
        gameOver: false
      };
      
      const territoryNames = ["Docks", "Warehouse District", "Downtown", "Suburbs", "Projects", "West Side", "East Side", "Market", "Old Town", "The Strip", "Airport", "Industrial Park", "Southside", "Northbridge", "Chinatown"]; 
      for (let i = 0; i < 15; i++) { 
          gameData.territories.push({ id: i, name: territoryNames[i], owner: 'Neutral', value: Math.floor(Math.random() * 50) + 10, soldiers: Math.floor(Math.random() * 4), lieutenant: -1, business: null });
      } 
      
      const aiNames = ["El Jefe", "La Reina", "The Ghost"]; 
      for (let i = 0; i < aiCount; i++) { 
          const aiId = `AI-${i + 1}`; 
          gameData.aiPlayers.push({ id: aiId, name: aiNames[i], money: 3000, powerLevel: 1, relationship: 0, spies: 1 });
      }
    }

    // =================================================================================
    // SECTION 2: GAME START, LOOP, & PAUSE
    // =================================================================================

    function startGame(mode) {
      playerName = document.getElementById('playerName').value || "Player";
      gameMode = mode;
      document.getElementById('menu').style.display = 'none';
      if (gameMode === 'single') {
        const aiCount = parseInt(document.getElementById('aiCount').value) || 2;
        document.getElementById('game').style.display = 'block';
        resetGameData(aiCount);
        isPaused = false;
        gameLoopInterval = setInterval(gameLoop, 2000);
        updateUI();
      }
    }

    function gameLoop() {
      if (isPaused || gameData.gameOver) return;
      if (gameData.heat >= 200) triggerGameOver("BUSTED! The heat was too much.");
      runProduction();
      runLaundering();
      runPersonnelSystem();
      runEmpireManagement();
      runAiTurns();
      updateResearch();
      checkVictoryConditions();
      if (gameData.heat > 0) gameData.heat -= 1;
      if (gameData.heat >= 100 && Math.random() > 0.7) triggerRaid();
      updateUI();
    }

    function togglePause() {
      if (gameData.gameOver) return;
      isPaused = !isPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      const pauseOverlay = document.getElementById('pauseOverlay');
      if (isPaused) {
        clearInterval(gameLoopInterval);
        if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') ytPlayer.pauseVideo();
        pauseBtn.textContent = "Resume";
        pauseOverlay.style.display = 'flex';
      } else {
        gameLoopInterval = setInterval(gameLoop, 2000);
        if (ytPlayer && typeof ytPlayer.playVideo === 'function') ytPlayer.playVideo();
        pauseBtn.textContent = "Pause";
        pauseOverlay.style.display = 'none';
      }
    }

    // =================================================================================
    // SECTION 3: YOUTUBE MUSIC PLAYER
    // =================================================================================
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    window.onYouTubeIframeAPIReady = function() {
      ytPlayer = new YT.Player('youtube-player-container', {
        height: '1', width: '1',
        playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 1, 'listType': 'playlist', 'list': 'OLAK5uy_k2u2jXntExJQY_M3yTcX2AMmsJJSsDBB0' },
        events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
      });
    }

    function onPlayerReady(event) { event.target.setVolume(50); event.target.playVideo(); }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING) {
        document.getElementById('song-title').textContent = ytPlayer.getVideoData().title;
      }
    }

    function nextSong() { if (ytPlayer) ytPlayer.nextVideo(); }
    function prevSong() { if (ytPlayer) ytPlayer.previousVideo(); }

    // =================================================================================
    // SECTION 4: CORE GAMEPLAY LOOPS
    // =================================================================================
    function handleButtonClick(actionFn, ...args) { if (isPaused) { showNotification("Game is paused!", "orange"); return; } actionFn(...args); if (gameMode === 'single') updateUI(); }
    
    function runProduction() {
      const drugPrices = { weed: 10, meth: 50, coke: 200, heroin: 500, fentanyl: 1500 };
      let productionRate = (gameData.personnel.producers * 0.1) * (gameData.labLevel + 1);
      let sellRate = gameData.personnel.dealers * 0.5;
      let soldAmount = Math.min(gameData.inventory[gameData.currentDrug], sellRate);
      if (soldAmount > 0) {
          gameData.inventory[gameData.currentDrug] -= soldAmount;
          let earnings = soldAmount * drugPrices[gameData.currentDrug];
          gameData.money += earnings;
          gameData.heat += soldAmount * 0.05 * (gameData.labLevel + 1);
      }
    }

    function runLaundering() {
      let launderingCap = gameData.lieutenants.length * 1000;
      if (gameData.research.laundering1.unlocked) launderingCap *= 1.5;
      if (gameData.properties) {
        launderingCap += gameData.properties.reduce((sum, p) => sum + p.cleanRate, 0);
      }
      let amountToLaunder = Math.min(gameData.money, launderingCap);
      if(amountToLaunder > 0) {
          gameData.money -= amountToLaunder;
          gameData.whiteMoney += amountToLaunder * 0.7;
      }
    }

    function runPersonnelSystem() {
        const totalPersonnel = gameData.personnel.producers + gameData.personnel.dealers + gameData.personnel.soldiers + gameData.personnel.spies;
        const wages = totalPersonnel * 50;
        if (gameData.money >= wages) {
          gameData.money -= wages;
          if (gameData.personnelLoyalty < 100) gameData.personnelLoyalty += 1;
        } else {
          gameData.personnelLoyalty = Math.max(0, gameData.personnelLoyalty - 5);
          showNotification("Can't afford payroll! Morale is dropping!", "red");
        }
    }

    function runEmpireManagement() {
        let territoryIncome = gameData.territories.reduce((sum, t) => {
            return t.owner === 'Player' ? sum + (t.value * 10) : sum;
        }, 0);
        gameData.money += territoryIncome;
    }

    // =================================================================================
    // SECTION 5: PLAYER ACTIONS
    // =================================================================================
    function hirePersonnel(type) {
        const costs = { producer: 500, dealer: 750, soldier: 1000, spy: 25000, lieutenant: 50000 };
        const cost = costs[type];
        if (gameData.money >= cost) {
            gameData.money -= cost;
            if (type === 'lieutenant') {
                const names = ["Rico", "Chico", "Lefty", "Sonny", "Benny", "Marco", "Vito", "Luca"];
                gameData.lieutenants.push({ name: names[Math.floor(Math.random() * names.length)], skill: 'logistics' });
            } else { gameData.personnel[type + 's']++; }
            showNotification(`Hired a new ${type}.`, "lightgreen");
        } else { showNotification(`Not enough money to hire a ${type}.`, "orange"); }
    }

    function assignLieutenant(ltIndex) { showNotification("Assign feature coming soon.", "lightblue"); }
    
    function upgradeLab() {
        const costs = [25000, 100000, 500000, 2000000, 10000000];
        const drugs = ["weed", "meth", "coke", "heroin", "fentanyl"];
        if (gameData.labLevel >= costs.length) { showNotification("Lab is max level.", "lightblue"); return; }
        let cost = costs[gameData.labLevel];
        if (gameData.money >= cost) {
            gameData.money -= cost;
            gameData.labLevel++;
            gameData.currentDrug = drugs[gameData.labLevel];
            showNotification(`Lab upgraded to produce ${gameData.currentDrug}!`, "lightgreen");
        } else { showNotification(`Need $${cost} to upgrade lab.`, "orange"); }
    }

    // --- Fix 5: Custom Drug Creation ---
    function createCustomDrug(name) {
        if (!name) return;
        const addictiveness = parseFloat(Math.random().toFixed(2));   // 0.00 - 1.00
        const basePrice = 100 + Math.floor(Math.random() * 400);

        if (!gameData.customDrugs) gameData.customDrugs = [];
        gameData.customDrugs.push({
            name,
            addictiveness,
            basePrice,
            demand: Math.floor(50 + addictiveness * 100)
        });

        showNotification(`${name} created! Addictiveness: ${addictiveness}`, "lightgreen");
        updateUI();
    }

    // Add button to UI when lab exists
    function addCustomDrugButton() {
        if (gameData.labLevel > 0) {
            const operationsPanel = document.getElementById('operations');
            const existingBtn = operationsPanel.querySelector('[onclick*="createCustomDrug"]');
            if (!existingBtn) {
                const btn = document.createElement('button');
                btn.textContent = "Create New Drug";
                btn.onclick = () => createCustomDrug(prompt("Enter drug name:"));
                operationsPanel.appendChild(btn);
            }
        }
    }

    function upgradeWorkshop() { showNotification("Workshop feature coming soon.", "lightblue"); }
    function manufactureArms() { showNotification("Arms feature coming soon.", "lightblue"); }
    function sellArms() { showNotification("Arms feature coming soon.", "lightblue"); }

    function fightBack() {
      if (gameData.personnel.soldiers < 1) { showNotification("You have no soldiers to fight back with!", "orange"); return; }
      showNotification("You're fighting back against the heat!");
      if (Math.random() > 0.5) {
        showNotification("You fought back successfully! Heat rose by 15.", "lightgreen");
        gameData.heat += 15;
      } else {
        showNotification("Fight failed. You lost money and a soldier!", "red");
        gameData.money = Math.max(0, gameData.money - 5000);
        gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - 1);
      }
    }

    function attackTerritory(territoryId) {
      const territory = gameData.territories[territoryId];
      if (territory.owner === 'Player') { showNotification("You already control this territory.", "orange"); return; }
      if (gameData.personnel.soldiers < 1) { showNotification("You need soldiers to take territory!", "orange"); return; }
      let attackPower = gameData.personnel.soldiers;
      let defensePower = territory.soldiers;
      if (attackPower > defensePower) {
        territory.owner = 'Player';
        territory.soldiers = Math.max(1, Math.floor(attackPower / 2)); // Leave at least 1 soldier
        gameData.personnel.soldiers = Math.ceil(gameData.personnel.soldiers / 2);
        showNotification(`You captured ${territory.name}!`, "lightgreen");
      } else {
        gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - defensePower);
        showNotification("Your attack failed! You lost soldiers.", "red");
      }
      checkPhaseTransition();
    }

    // --- Fix 4: Phase Transition ---
    function playerControlsAllTerritories() {
        return gameData.territories.every(t => t.owner === 'Player');
    }

    function checkPhaseTransition() {
        if (playerControlsAllTerritories() && !gameData.cityControlled) {
            gameData.cityControlled = true;
            showPhaseChoice();
        }
    }

    function showPhaseChoice() {
        let choice = confirm("You now control the city. Do you want to compete for PRODUCTION or DISTRIBUTION of high-end drugs?");
        if (choice) {
            gameData.nextPhase = "production";
            loadNewMap("production");
        } else {
            gameData.nextPhase = "distribution";
            loadNewMap("distribution");
        }
    }

    function loadNewMap(phase) {
        // Example: reset territories for new city map
        const newTerritories = [];
        const territoryNames = ["Downtown", "Uptown", "Harbor", "Chinatown", "Financial District", "Suburbs", "Industrial Zone", "Old Quarter", "Airport", "Casino Strip"];
        for (let i = 0; i < territoryNames.length; i++) {
            newTerritories.push({ id: i, name: territoryNames[i], owner: 'Neutral', value: Math.floor(Math.random()*50)+50, soldiers: Math.floor(Math.random()*5), lieutenant: -1, business: null });
        }
