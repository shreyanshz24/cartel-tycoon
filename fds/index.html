<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartel Tycoon: Grand Strategy</title>
  <style>
    :root {
      --main-green: #00ff00;
      --main-red: #ff0000;
      --dark-bg: #0a0a0a;
      --card-bg: rgba(0, 20, 0, 0.7);
      --border-color: #003300;
      --player-color: #0077ff;
      --ai1-color: #ff7700;
      --ai2-color: #ff00ff;
      --ai3-color: #ffff00;
      --neutral-color: #555;
    }

    body {
      font-family: 'Courier New', monospace;
      background: var(--dark-bg);
      color: var(--main-green);
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .container {
      display: none;
      padding: 15px;
      max-width: 1600px;
      margin: 0 auto;
      text-align: left;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }

    .header h1 {
      font-size: 2rem;
      color: var(--main-red);
      text-shadow: 0 0 15px var(--main-red);
      margin: 0;
    }

    .top-stats-bar {
      display: flex;
      gap: 20px;
      background: var(--card-bg);
      padding: 5px 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    main {
      display: grid;
      grid-template-columns: 320px 1fr 320px;
      gap: 15px;
      height: calc(100vh - 100px);
    }

    .card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 255, 0, 0.4);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
    }

    h2 {
      border-bottom: 1px solid var(--main-green);
      padding-bottom: 4px;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 1.2rem;
    }

    h3 {
      font-size: 1rem;
      margin: 10px 0 5px 0;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 3px;
    }

    p {
      font-size: 0.9rem;
      line-height: 1.5;
      margin: 4px 0;
    }

    button {
      width: 100%;
      padding: 8px 10px;
      margin: 4px 0;
      background: var(--main-red);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      box-sizing: border-box;
      font-size: 0.9rem;
    }
    
    button:disabled {
        background: #555;
        cursor: not-allowed;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 10px;
    }

    .tab-link {
      background: none;
      border-radius: 6px 6px 0 0;
      border: 1px solid transparent;
      border-bottom: none;
      color: var(--main-green);
      opacity: 0.6;
      margin: 0 2px;
      flex-grow: 1;
      padding: 8px;
      font-size: 0.9rem;
    }

    .tab-link.active {
      background: var(--card-bg);
      border-color: var(--border-color);
      opacity: 1;
    }

    .tab-content {
      display: none;
      flex-grow: 1;
      overflow-y: auto;
    }

    .tab-content.active {
      display: block;
    }

    .item-list {
      overflow-y: auto;
      height: 100%;
    }

    .list-item {
      border-top: 1px solid var(--border-color);
      padding: 8px 0;
      margin-top: 8px;
    }

    #map-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
    }

    .territory {
        height: 60px;
        border: 2px solid #333;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .territory:hover {
        transform: scale(1.05);
        border-color: var(--main-green);
    }
    .player-controlled { background-color: var(--player-color); }
    .ai-1-controlled { background-color: var(--ai1-color); }
    .ai-2-controlled { background-color: var(--ai2-color); }
    .ai-3-controlled { background-color: var(--ai3-color); }
    .neutral-controlled { background-color: var(--neutral-color); }
    .assign-mode { border: 3px dashed yellow !important; }

    /* --- NEW: Music Player Styles --- */
    #music-player {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card-bg);
      padding: 5px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    #song-title {
      font-size: 0.9rem;
      width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #music-player button {
      width: 40px;
      padding: 5px;
    }

    #youtube-player-container {
      display: none;
    }

    /* Hide the actual YouTube iframe */

    #menu {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      color: #f00;
      font-size: 3rem;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }

    #pauseBtn {
      width: 100px;
      background-color: #ffae00;
    }

    #pauseOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      color: #ffae00;
      font-size: 5rem;
      text-shadow: 0 0 15px #ffae00;
      justify-content: center;
      align-items: center;
      z-index: 999;
      cursor: pointer;
    }
    
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #333;
      border-radius: 5px;
      margin: 5px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--main-green);
      border-radius: 5px;
      transition: width 0.3s ease;
    }
  </style>
</head>

<body>
  <div id="menu">
    <h1>Cartel Tycoon</h1>
    <input type="text" id="playerName" placeholder="Enter Your Name"
      style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
    <div id="singlePlayerOptions">
      <label for="aiCount" style="font-size: 1.5rem; color: #0f0;">AI Opponents (1-3):</label>
      <input type="number" id="aiCount" value="2" min="1" max="3"
        style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
    </div>
    <button id="startGameBtn" style="width: 300px;">Single Player</button>
  </div>

  <div id="game" class="container">
    <header class="header">
      <h1>Cartel Tycoon</h1>
      <div id="music-player">
        <button onclick="prevSong()">‚èÆ</button>
        <span id="song-title">Loading Music...</span>
        <button onclick="nextSong()">‚è≠</button>
      </div>
      <div class="top-stats-bar" id="top-stats"></div>
      <button id="pauseBtn" onclick="togglePause()">Pause</button>
    </header>
    <main>
      <div class="card" id="operations"></div>
      <div class="card" id="center-panel"></div>
      <div class="card" id="personnel-inventory"></div>
    </main>
  </div>

  <div id="notifications"
    style="position:fixed;top:20px;right:20px;width:300px;z-index:1001;font-weight:bold;text-align:right;"></div>
  <div id="gameOverScreen"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);color:#0f0;font-size:3rem;justify-content:center;align-items:center;flex-direction:column;z-index:1000;">
    <h2 id="gameOverText"></h2><button onclick="location.reload()">Start Over</button>
  </div>
  <div id="pauseOverlay" onclick="togglePause()">PAUSED</div>
  <div id="event-modal"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center;">
    <div class="modal-content" id="event-content"
      style="width:500px;background:#0a0a0a;border:2px solid #f00;padding:20px;text-align:center;box-shadow:0 0 30px #f00;">
    </div>
  </div>
  <div id="territory-modal"
    style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center;">
    <div class="modal-content" id="territory-modal-content"
      style="width:500px;background:#0a0a0a;border:2px solid #0f0;padding:20px;text-align:center;"></div>
  </div>
  <div id="youtube-player-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        
    // =================================================================================
    // SECTION 1: CORE GAME SETUP & STATE
    // =================================================================================
    let playerName = "";
    let gameData = {};
    let gameLoopInterval = null;
    let isPaused = false;
    let gameMode = 'single';
    let currentActiveTab = 'map-panel';
    let currentActiveSubTab = 'lieutenants-subpanel';
    let isAssigningLieutenant = -1;
    let ytPlayer;

    // Make functions globally accessible for HTML onclicks
    window.startGame = startGame;
    window.togglePause = togglePause;
    window.prevSong = prevSong;
    window.nextSong = nextSong;
    window.handleButtonClick = handleButtonClick;
    window.showTab = showTab;
    window.showSubTab = showSubTab;
    window.upgradeLab = upgradeLab;
    window.upgradeWorkshop = upgradeWorkshop;
    window.manufactureArms = manufactureArms;
    window.sellArms = sellArms;
    window.fightBack = fightBack;
    window.hirePersonnel = hirePersonnel;
    window.attackTerritory = attackTerritory;
    window.assignLieutenant = assignLieutenant;
    window.proposeDeal = proposeDeal;
    window.startResearch = startResearch;
    window.sendSpyMission = sendSpyMission;
    window.buyProperty = buyProperty;
    window.produceWeed = produceWeed;

    document.getElementById('startGameBtn').addEventListener('click', () => startGame('single'));

    document.addEventListener("keydown", function(e) {
        if (!gameData || Object.keys(gameData).length === 0) return; // Cheats only work once game starts
        if (e.key === "1") { gameData.money += 100000; showNotification("Cheat: +100k Dirty", "lightgreen"); updateUI(); }
        if (e.key === "2") { gameData.whiteMoney += 100000; showNotification("Cheat: +100k Clean", "lightgreen"); updateUI(); }
        if (e.key === "3") { gameData.personnel.soldiers += 10; showNotification("Cheat: +10 Soldiers", "lightgreen"); updateUI(); }
        if (e.key === "4") { gameData.heat = 0; showNotification("Cheat: Heat Reset", "lightblue"); updateUI(); }
    });

    function resetGameData(aiCount = 2) {
      gameData = {
        money: 7500, whiteMoney: 0, heat: 0,
        inventory: { weed: 10, meth: 0, coke: 0, heroin: 0, fentanyl: 0, chemicals: 0 },
        armsStock: { handgun: 0, smg: 0, rifle: 0 },
        labLevel: 0, armsTier: 0, currentDrug: "weed",
        personnel: { producers: 0, dealers: 0, soldiers: 0, spies: 0 },
        lieutenants: [],
        properties: [],
        personnelLoyalty: 75,
        territories: [],
        aiPlayers: [],
        research: {
          logistics1: { name: 'Faster Couriers', desc: '+10% Dealer efficiency.', cost: 10000, time: 60, progress: 0, unlocked: false, requires: null },
          logistics2: { name: 'Bulk Chemicals', desc: 'Buy Chemicals in larger, cheaper batches.', cost: 50000, time: 120, progress: 0, unlocked: false, requires: 'logistics1' },
          military1: { name: 'Body Armor', desc: '+10% Soldier defense.', cost: 25000, time: 90, progress: 0, unlocked: false, requires: null },
          military2: { name: 'Assault Rifles', desc: '+15% Soldier attack power.', cost: 100000, time: 180, progress: 0, unlocked: false, requires: 'military1' },
          laundering1: { name: 'Shell Corps', desc: 'Lieutenants take a smaller cut.', cost: 75000, time: 150, progress: 0, unlocked: false, requires: null },
        },
        researchInProgress: null,
        victory: {
          domination: { current: 0, required: 15 },
          economic: { current: 0, required: 20000000 },
          status: 'Ongoing'
        },
        gangs: [
            { name: "Local Thugs", drug: "weed", strength: 1 },
            { name: "Street Gangs", drug: "meth", strength: 2 },
            { name: "Big City Gangs", drug: "coke", strength: 3 },
            { name: "Cartel", drug: "heroin", strength: 4 },
            { name: "Super Cartel", drug: "fentanyl", strength: 5 }
        ],
        gameOver: false,
        // NEW: Drug earning caps and manual production
        drugEarningCaps: { weed: 5000, meth: 15000, coke: 50000, heroin: 150000, fentanyl: 500000 },
        drugEarnings: { weed: 0, meth: 0, coke: 0, heroin: 0, fentanyl: 0 },
        manualProduction: { weed: { progress: 0, time: 10 } }
      };
      
      const territoryNames = ["Docks", "Warehouse District", "Downtown", "Suburbs", "Projects", "West Side", "East Side", "Market", "Old Town", "The Strip", "Airport", "Industrial Park", "Southside", "Northbridge", "Chinatown"]; 
      for (let i = 0; i < 15; i++) { 
          gameData.territories.push({ id: i, name: territoryNames[i], owner: 'Neutral', value: Math.floor(Math.random() * 50) + 10, soldiers: Math.floor(Math.random() * 4), lieutenant: -1, business: null });
      } 
      
      const aiNames = ["El Jefe", "La Reina", "The Ghost"]; 
      for (let i = 0; i < aiCount; i++) { 
          const aiId = `AI-${i + 1}`; 
          gameData.aiPlayers.push({ id: aiId, name: aiNames[i], money: 3000, powerLevel: 1, relationship: 0, spies: 1 });
      }
    }

    // =================================================================================
    // SECTION 2: GAME START, LOOP, & PAUSE
    // =================================================================================

    function startGame(mode) {
      playerName = document.getElementById('playerName').value || "Player";
      gameMode = mode;
      document.getElementById('menu').style.display = 'none';
      if (gameMode === 'single') {
        const aiCount = parseInt(document.getElementById('aiCount').value) || 2;
        document.getElementById('game').style.display = 'block';
        resetGameData(aiCount);
        isPaused = false;
        gameLoopInterval = setInterval(gameLoop, 2000);
        updateUI();
      }
    }

    function gameLoop() {
      if (isPaused || gameData.gameOver) return;
      if (gameData.heat >= 200) triggerGameOver("BUSTED! The heat was too much.");
      runProduction();
      runLaundering();
      runPersonnelSystem();
      runEmpireManagement();
      runAiTurns();
      updateResearch();
      updateManualProduction();
      checkVictoryConditions();
      if (gameData.heat > 0) gameData.heat -= 1;
      if (gameData.heat >= 100 && Math.random() > 0.7) triggerRaid();
      updateUI();
    }

    function togglePause() {
      if (gameData.gameOver) return;
      isPaused = !isPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      const pauseOverlay = document.getElementById('pauseOverlay');
      if (isPaused) {
        clearInterval(gameLoopInterval);
        if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') ytPlayer.pauseVideo();
        pauseBtn.textContent = "Resume";
        pauseOverlay.style.display = 'flex';
      } else {
        gameLoopInterval = setInterval(gameLoop, 2000);
        if (ytPlayer && typeof ytPlayer.playVideo === 'function') ytPlayer.playVideo();
        pauseBtn.textContent = "Pause";
        pauseOverlay.style.display = 'none';
      }
    }

    // =================================================================================
    // SECTION 3: YOUTUBE MUSIC PLAYER
    // =================================================================================
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    window.onYouTubeIframeAPIReady = function() {
      ytPlayer = new YT.Player('youtube-player-container', {
        height: '1', width: '1',
        playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 1, 'listType': 'playlist', 'list': 'OLAK5uy_k2u2jXntExJQY_M3yTcX2AMmsJJSsDBB0' },
        events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
      });
    }

    function onPlayerReady(event) { event.target.setVolume(50); event.target.playVideo(); }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING) {
        document.getElementById('song-title').textContent = ytPlayer.getVideoData().title;
      }
    }

    function nextSong() { if (ytPlayer) ytPlayer.nextVideo(); }
    function prevSong() { if (ytPlayer) ytPlayer.previousVideo(); }

    // =================================================================================
    // SECTION 4: CORE GAMEPLAY LOOPS
    // =================================================================================
    function handleButtonClick(actionFn, ...args) { if (isPaused) { showNotification("Game is paused!", "orange"); return; } actionFn(...args); if (gameMode === 'single') updateUI(); }
    
    function runProduction() {
      const drugPrices = { weed: 10, meth: 50, coke: 200, heroin: 500, fentanyl: 1500 };
      let productionRate = (gameData.personnel.producers * 0.1) * (gameData.labLevel + 1);
      let sellRate = gameData.personnel.dealers * 0.5;
      let soldAmount = Math.min(gameData.inventory[gameData.currentDrug], sellRate);
      
      if (soldAmount > 0) {
          // Check if we've reached the earning cap for this drug
          const potentialEarnings = soldAmount * drugPrices[gameData.currentDrug];
          const remainingCap = gameData.drugEarningCaps[gameData.currentDrug] - gameData.drugEarnings[gameData.currentDrug];
          
          if (remainingCap > 0) {
              const actualEarnings = Math.min(potentialEarnings, remainingCap);
              const actualSold = Math.floor(actualEarnings / drugPrices[gameData.currentDrug]);
              
              gameData.inventory[gameData.currentDrug] -= actualSold;
              gameData.money += actualEarnings;
              gameData.drugEarnings[gameData.currentDrug] += actualEarnings;
              gameData.heat += actualSold * 0.05 * (gameData.labLevel + 1);
              
              if (actualEarnings < potentialEarnings) {
                  showNotification(`Market saturated! ${gameData.currentDrug.toUpperCase()} earnings capped at $${gameData.drugEarningCaps[gameData.currentDrug]}`, "orange");
              }
          }
      }
    }

    function runLaundering() {
      let launderingCap = gameData.lieutenants.length * 1000;
      if (gameData.research.laundering1.unlocked) launderingCap *= 1.5;
      if (gameData.properties) {
        launderingCap += gameData.properties.reduce((sum, p) => sum + p.cleanRate, 0);
      }
      let amountToLaunder = Math.min(gameData.money, launderingCap);
      if(amountToLaunder > 0) {
          gameData.money -= amountToLaunder;
          gameData.whiteMoney += amountToLaunder * 0.7;
      }
    }

    function runPersonnelSystem() {
        const totalPersonnel = gameData.personnel.producers + gameData.personnel.dealers + gameData.personnel.soldiers + gameData.personnel.spies;
        const wages = totalPersonnel * 50;
        if (gameData.money >= wages) {
          gameData.money -= wages;
          if (gameData.personnelLoyalty < 100) gameData.personnelLoyalty += 1;
        } else {
          gameData.personnelLoyalty = Math.max(0, gameData.personnelLoyalty - 5);
          showNotification("Can't afford payroll! Morale is dropping!", "red");
        }
    }

    function runEmpireManagement() {
        let territoryIncome = gameData.territories.reduce((sum, t) => {
            return t.owner === 'Player' ? sum + (t.value * 10) : sum;
        }, 0);
        gameData.money += territoryIncome;
    }
    
    function updateManualProduction() {
        // Update manual weed production progress
        if (gameData.manualProduction.weed.progress > 0) {
            gameData.manualProduction.weed.progress--;
            if (gameData.manualProduction.weed.progress === 0) {
                gameData.inventory.weed += 5;
                showNotification("Manual production complete: +5 Weed", "lightgreen");
            }
        }
    }

    // =================================================================================
    // SECTION 5: PLAYER ACTIONS
    // =================================================================================
    function hirePersonnel(type) {
        const costs = { producer: 500, dealer: 750, soldier: 1000, spy: 25000, lieutenant: 50000 };
        const cost = costs[type];
        if (gameData.money >= cost) {
            gameData.money -= cost;
            if (type === 'lieutenant') {
                const names = ["Rico", "Chico", "Lefty", "Sonny", "Benny", "Marco", "Vito", "Luca"];
                gameData.lieutenants.push({ name: names[Math.floor(Math.random() * names.length)], skill: 'logistics' });
            } else { gameData.personnel[type + 's']++; }
            showNotification(`Hired a new ${type}.`, "lightgreen");
        } else { showNotification(`Not enough money to hire a ${type}.`, "orange"); }
    }

    function assignLieutenant(ltIndex) { showNotification("Assign feature coming soon.", "lightblue"); }
    
    function upgradeLab() {
        const costs = [25000, 100000, 500000, 2000000, 10000000];
        const drugs = ["weed", "meth", "coke", "heroin", "fentanyl"];
        if (gameData.labLevel >= costs.length) { showNotification("Lab is max level.", "lightblue"); return; }
        let cost = costs[gameData.labLevel];
        if (gameData.money >= cost) {
            gameData.money -= cost;
            gameData.labLevel++;
            gameData.currentDrug = drugs[gameData.labLevel];
            showNotification(`Lab upgraded to produce ${gameData.currentDrug}!`, "lightgreen");
        } else { showNotification(`Need $${cost} to upgrade lab.`, "orange"); }
    }
    
    // NEW: Manual weed production function
    function produceWeed() {
        if (gameData.manualProduction.weed.progress > 0) {
            showNotification("Already producing weed!", "orange");
            return;
        }
        
        gameData.manualProduction.weed.progress = gameData.manualProduction.weed.time;
        showNotification("Started manual weed production", "lightgreen");
    }

    function upgradeWorkshop() { showNotification("Workshop feature coming soon.", "lightblue"); }
    function manufactureArms() { showNotification("Arms feature coming soon.", "lightblue"); }
    function sellArms() { showNotification("Arms feature coming soon.", "lightblue"); }

    function fightBack() {
      if (gameData.personnel.soldiers < 1) { showNotification("You have no soldiers to fight back with!", "orange"); return; }
      showNotification("You're fighting back against the heat!");
      if (Math.random() > 0.5) {
        showNotification("You fought back successfully! Heat rose by 15.", "lightgreen");
        gameData.heat += 15;
      } else {
        showNotification("Fight failed. You lost money and a soldier!", "red");
        gameData.money = Math.max(0, gameData.money - 5000);
        gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - 1);
      }
    }

    function attackTerritory(territoryId) {
      const territory = gameData.territories[territoryId];
      if (territory.owner === 'Player') { showNotification("You already control this territory.", "orange"); return; }
      if (gameData.personnel.soldiers < 1) { showNotification("You need soldiers to take territory!", "orange"); return; }
      let attackPower = gameData.personnel.soldiers;
      let defensePower = territory.soldiers;
      if (attackPower > defensePower) {
        territory.owner = 'Player';
        territory.soldiers = Math.max(1, Math.floor(attackPower / 2)); // Leave at least 1 soldier
        gameData.personnel.soldiers = Math.ceil(gameData.personnel.soldiers / 2);
        showNotification(`You captured ${territory.name}!`, "lightgreen");
      } else {
        gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - defensePower);
        showNotification("Your attack failed! You lost soldiers.", "red");
      }
    }

    function buyProperty(name, cost, cleanRate) {
      if (gameData.money < cost) { showNotification("Not enough dirty money!", "orange"); return; }
      gameData.money -= cost;
      if (!gameData.properties) gameData.properties = [];
      gameData.properties.push({ name, cleanRate });
      showNotification(`${name} purchased!`, "lightgreen");
    }

    // =================================================================================
    // SECTION 6: ESPIONAGE, EVENTS, AI, DIPLOMACY
    // =================================================================================
    function sendSpyMission(type) {
      if (gameData.personnel.spies <= 0) { showNotification("You need spies for this mission.", "orange"); return; }
      gameData.personnel.spies--;
      showNotification("A spy has been dispatched...", "lightblue");
      let chance = Math.random();
      if (type === "intel" && chance > 0.4) { showNotification("SUCCESS: Your spies stole rival production intel!", "lightgreen");
      } else if (type === "cops" && chance > 0.6) { showNotification("SUCCESS: You bribed the cops successfully! Heat is down.", "lightgreen"); gameData.heat = Math.max(0, gameData.heat - 25);
      } else if (type === "rival" && chance > 0.7) { showNotification("SUCCESS: Rival operations sabotaged!", "lightgreen");
      } else { showNotification("FAILURE: Your spy was caught! Retaliation incoming.", "red"); gameData.heat += 20; }
    }
    
    function triggerRaid() {
        showNotification("POLICE RAID!", "red");
        gameData.heat += 30;
        const moneyLost = Math.floor(gameData.money * 0.2);
        gameData.money -= moneyLost;
        const dealersLost = Math.min(gameData.personnel.dealers, 2);
        gameData.personnel.dealers -= dealersLost;
        showNotification(`You lost $${moneyLost} and ${dealersLost} dealers!`, "red");
        if (gameData.heat >= 200) { triggerGameOver("The raid was too much! You're BUSTED!"); }
    }

    function runAiTurns() {
        gameData.aiPlayers.forEach(ai => {
            ai.money += 100 * ai.powerLevel;
            if (Math.random() > 0.97) { 
                const weakTerritories = gameData.territories.filter(t => t.owner !== ai.id && t.soldiers < (ai.powerLevel * 2));
                if (weakTerritories.length > 0) {
                    const target = weakTerritories[Math.floor(Math.random() * weakTerritories.length)];
                    target.owner = ai.id;
                    target.soldiers = ai.powerLevel;
                    showNotification(`${ai.name} has taken control of ${target.name}!`, "orange");
                }
            }
        });
    }

    function proposeDeal(aiIndex) { showNotification("Diplomacy feature coming soon.", "lightblue"); }

    // =================================================================================
    // SECTION 7: RESEARCH & DEVELOPMENT
    // =================================================================================
    function startResearch(researchId) {
        if (gameData.researchInProgress) { showNotification("Research already in progress.", "orange"); return; }
        const r = gameData.research[researchId];
        if (gameData.whiteMoney < r.cost) { showNotification(`Need $${r.cost} in clean money for research.`, "orange"); return; }
        const requirementMet = r.requires ? gameData.research[r.requires].unlocked : true;
        if (!requirementMet) { showNotification("Previous technology not researched yet.", "orange"); return; }
        gameData.whiteMoney -= r.cost;
        gameData.researchInProgress = researchId;
        showNotification(`Research started on ${r.name}.`, "lightblue");
    }

    function updateResearch() {
        if (gameData.researchInProgress) {
            const r = gameData.research[gameData.researchInProgress];
            r.progress += 2;
            if (r.progress >= r.time) {
                r.unlocked = true;
                r.progress = r.time;
                showNotification(`Research complete: ${r.name}!`, "lightgreen");
                gameData.researchInProgress = null;
            }
        }
    }

    // =================================================================================
    // SECTION 8: VICTORY CONDITIONS
    // =================================================================================
    function checkVictoryConditions() {
        if (gameData.gameOver) return;
        gameData.victory.domination.current = gameData.territories.filter(t => t.owner === 'Player').length;
        if (gameData.victory.domination.current >= gameData.victory.domination.required) { triggerGameOver("VICTORY! You control the city."); }
        gameData.victory.economic.current = gameData.whiteMoney;
        if (gameData.victory.economic.current >= gameData.victory.economic.required) { triggerGameOver("VICTORY! Your financial empire is untouchable."); }
    }

    // =================================================================================
    // SECTION 9: UI RENDERING
    // =================================================================================
    function showTab(tabName, event) { currentActiveTab = tabName; updateUI(); }
    function showSubTab(tabName, event) { currentActiveSubTab = tabName; updateUI(); }

    function updateUI() {
      if (!gameData || !gameData.territories || gameData.gameOver) return;

    // --- Top Stats ---
    document.getElementById('top-stats').innerHTML = `
        <p>üí∞ Dirty: $${Math.floor(gameData.money)}</p>
        <p>üíµ Clean: $${Math.floor(gameData.whiteMoney)}</p>
        <p>üî• Heat: ${Math.floor(gameData.heat)}</p>
    `;

    // --- Operations Panel ---
    const weedProgressPercent = (gameData.manualProduction.weed.progress / gameData.manualProduction.weed.time) * 100;
    document.getElementById('operations').innerHTML = `
        <h2>Operations</h2>
        <div class="item-list">
            <h3>Drug Operation</h3>
            <p>Current Production: ${gameData.currentDrug.toUpperCase()}</p>
            <p>Earnings: $${gameData.drugEarnings[gameData.currentDrug]}/$${gameData.drugEarningCaps[gameData.currentDrug]}</p>
            <button onclick="handleButtonClick(upgradeLab)">
                Upgrade Lab (Lvl ${gameData.labLevel})
            </button>
            
            <h3>Manual Production</h3>
            <p>Weed: ${gameData.inventory.weed} units</p>
            <div class="progress-bar">
                <div class="progress-fill" style="width: ${100 - weedProgressPercent}%;"></div>
            </div>
            <button onclick="handleButtonClick(produceWeed)" ${gameData.manualProduction.weed.progress > 0 ? 'disabled' : ''}>
                ${gameData.manualProduction.weed.progress > 0 ? 'Producing...' : 'Produce Weed (5 units)'}
            </button>

            <h3>Arms Trafficking</h3>
            <p>Workshop Tier: ${gameData.armsTier}</p>
            <button onclick="handleButtonClick(upgradeWorkshop)">Upgrade Workshop</button>
            <button onclick="handleButtonClick(manufactureArms)">Manufacture Arms</button>
            <button onclick="handleButtonClick(sellArms)">Sell Arms</button>

            <h3>Law Enforcement</h3>
            <button onclick="handleButtonClick(fightBack)">Fight Back</button>
        </div>
    `;

    // --- Center Panel Tabs ---
    document.getElementById('center-panel').innerHTML = `
        <div class="tab-buttons">
            <button class="tab-link ${currentActiveTab === 'map-panel' ? 'active' : ''}" onclick="showTab('map-panel', event)">Map</button>
            <button class="tab-link ${currentActiveTab === 'management-panel' ? 'active' : ''}" onclick="showTab('management-panel', event)">Management</button>
            <button class="tab-link ${currentActiveTab === 'llc-panel' ? 'active' : ''}" onclick="showTab('llc-panel', event)">LLC</button>
            <button class="tab-link ${currentActiveTab === 'research-panel' ? 'active' : ''}" onclick="showTab('research-panel', event)">Research</button>
            <button class="tab-link ${currentActiveTab === 'espionage-panel' ? 'active' : ''}" onclick="showTab('espionage-panel', event)">Espionage</button>
        </div>
        <div id="map-panel" class="tab-content ${currentActiveTab === 'map-panel' ? 'active' : ''}"></div>
        <div id="management-panel" class="tab-content ${currentActiveTab === 'management-panel' ? 'active' : ''}"></div>
        <div id="llc-panel" class="tab-content ${currentActiveTab === 'llc-panel' ? 'active' : ''}"></div>
        <div id="research-panel" class="tab-content ${currentActiveTab === 'research-panel' ? 'active' : ''}"></div>
        <div id="espionage-panel" class="tab-content ${currentActiveTab === 'espionage-panel' ? 'active' : ''}"></div>
    `;

    // --- Espionage Panel ---
    document.getElementById('espionage-panel').innerHTML = `
        <h2>Espionage</h2>
        <p>Spies Available: ${gameData.personnel.spies}</p>
        <button onclick="handleButtonClick(hirePersonnel, 'spy')">Hire Spy ($25,000)</button>
        <hr/>
        <h3>Missions</h3>
        <button onclick="handleButtonClick(sendSpyMission, 'intel')">Steal Intel</button>
        <button onclick="handleButtonClick(sendSpyMission, 'cops')">Bribe Cops</button>
        <button onclick="handleButtonClick(sendSpyMission, 'rival')">Sabotage Rival</button>
    `;

    // --- LLC Panel ---
    let propertiesHTML = gameData.properties.map(p => `<p><strong>${p.name}</strong> (Cleans $${p.cleanRate}/tick)</p>`).join('');
    document.getElementById('llc-panel').innerHTML = `
        <h2>Property Laundering</h2>
        <p>Buy businesses to clean dirty money.</p>
        <hr/>
        <h3>Your Properties</h3>
        <div class="item-list">${propertiesHTML || '<p>None</p>'}</div>
        <hr/>
        <h3>For Sale</h3>
        <button onclick="buyProperty('Car Wash', 20000, 500)">Car Wash ($20,000)</button>
        <button onclick="buyProperty('Nightclub', 100000, 2500)">Nightclub ($100,000)</button>
        <button onclick="buyProperty('Casino', 1000000, 20000)">Casino ($1,000,000)</button>
    `;

    // --- Personnel / Empire Stats ---
    let loyaltyColor = gameData.personnelLoyalty > 60 ? 'lightgreen' : gameData.personnelLoyalty > 30 ? 'orange' : 'red';
    document.getElementById('personnel-inventory').innerHTML = `
        <h2>Empire Stats</h2>
        <div class="item-list">
            <h3>Personnel</h3>
            <p><strong>Morale: <span style="color:${loyaltyColor};">${gameData.personnelLoyalty.toFixed(1)}%</span></strong></p>
            <p>Producers: ${gameData.personnel.producers}</p>
            <button onclick="handleButtonClick(hirePersonnel, 'producer')">Hire ($500)</button>
            <p>Dealers: ${gameData.personnel.dealers}</p>
            <button onclick="handleButtonClick(hirePersonnel, 'dealer')">Hire ($750)</button>
            <p>Soldiers: ${gameData.personnel.soldiers}</p>
            <button onclick="handleButtonClick(hirePersonnel, 'soldier')">Hire ($1000)</button>
            <hr/>
            <h3>Victory Progress</h3>
            <p>Domination: ${gameData.victory.domination.current}/${gameData.victory.domination.required} Territories</p>
            <p>Economic: $${Math.floor(gameData.victory.economic.current)}/$${gameData.victory.economic.required}</p>
            <hr/>
            <h3>Drug Earnings</h3>
            <p>Weed: $${gameData.drugEarnings.weed}/$${gameData.drugEarningCaps.weed}</p>
            <p>Meth: $${gameData.drugEarnings.meth}/$${gameData.drugEarningCaps.meth}</p>
            <p>Coke: $${gameData.drugEarnings.coke}/$${gameData.drugEarningCaps.coke}</p>
            <p>Heroin: $${gameData.drugEarnings.heroin}/$${gameData.drugEarningCaps.heroin}</p>
            <p>Fentanyl: $${gameData.drugEarnings.fentanyl}/$${gameData.drugEarningCaps.fentanyl}</p>
        </div>
    `;

    // --- Map Panel ---
    let mapHTML = `<h2>City Map</h2><p>Click a territory to attack.</p><div id="map-grid">`;
    const ownerColors = { 'Player': 'player', 'AI-1': 'ai-1', 'AI-2': 'ai-2', 'AI-3': 'ai-3', 'Neutral': 'neutral' };
    gameData.territories.forEach(t => {
        mapHTML += `
            <div class="territory ${ownerColors[t.owner] || 'neutral'}-controlled"
                 onclick="handleButtonClick(attackTerritory, ${t.id})">
                 <span>${t.name}</span>
                 <span>${t.owner}</span>
                 <span>‚öîÔ∏è ${t.soldiers}</span>
            </div>`;
    });
    mapHTML += `</div>`;
    document.getElementById('map-panel').innerHTML = mapHTML;

    // --- Management Panel ---
    document.getElementById('management-panel').innerHTML = `
        <div class="tab-buttons">
            <button class="tab-link ${currentActiveSubTab === 'lieutenants-subpanel' ? 'active' : ''}" onclick="showSubTab('lieutenants-subpanel', event)">Lieutenants</button>
            <button class="tab-link ${currentActiveSubTab === 'diplomacy-subpanel' ? 'active' : ''}" onclick="showSubTab('diplomacy-subpanel', event)">Diplomacy</button>
        </div>
        <div id="lieutenants-subpanel" class="tab-content item-list ${currentActiveSubTab === 'lieutenants-subpanel' ? 'active' : ''}"></div>
        <div id="diplomacy-subpanel" class="tab-content item-list ${currentActiveSubTab === 'diplomacy-subpanel' ? 'active' : ''}"></div>
    `;

    // Lieutenants Subpanel
    let lieutenantsHTML = `<h3>Lieutenants</h3><button onclick="handleButtonClick(hirePersonnel, 'lieutenant')">Hire Lieutenant ($50,000)</button>`;
    gameData.lieutenants.forEach((lt, index) => {
        let territory = gameData.territories.find(t => t.lieutenant === index);
        lieutenantsHTML += `
            <div class="list-item">
                <strong>${lt.name}</strong>
                <p>Status: ${territory ? `Managing ${territory.name}` : 'Unassigned'}</p>
                <button onclick="handleButtonClick(assignLieutenant, ${index})">${territory ? 'Re-Assign' : 'Assign'}</button>
            </div>`;
    });
    document.getElementById('lieutenants-subpanel').innerHTML = lieutenantsHTML;

    // Diplomacy Subpanel
    let diplomacyHTML = `<h3>Rival Leaders</h3>`;
    gameData.aiPlayers.forEach((ai, index) => {
        let relPercent = (ai.relationship + 100) / 2;
        let totalSoldiers = gameData.territories.reduce((sum, t) => t.owner === ai.id ? sum + t.soldiers : sum, 0);
        diplomacyHTML += `
            <div class="list-item">
                <strong>${ai.name}</strong> (‚öîÔ∏è ${totalSoldiers})
                <div style="width:100%;height:8px;background:#333;border:1px solid #0f0;margin-top:5px;">
                    <div style="width:${relPercent}%;height:100%;background:#0f0;"></div>
                </div>
                <button onclick="handleButtonClick(proposeDeal, ${index})">Deal ($10k)</button>
            </div>`;
    });
    document.getElementById('diplomacy-subpanel').innerHTML = diplomacyHTML;

    // --- Research Panel ---
    let researchHTML = `<h2>Research & Development</h2>`;
    if (gameData.researchInProgress) {
        const r = gameData.research[gameData.researchInProgress];
        researchHTML += `<p>Research in Progress: ${r.name} (${Math.floor((r.progress / r.time) * 100)}%)</p>`;
    }
    researchHTML += `<div class="item-list">`;
    for (const [key, research] of Object.entries(gameData.research)) {
        const canResearch = !research.unlocked && !gameData.researchInProgress && 
                           (!research.requires || gameData.research[research.requires].unlocked);
        researchHTML += `
            <div class="list-item">
                <strong>${research.name}</strong>
                <p>${research.desc}</p>
                <p>Cost: $${research.cost} clean money</p>
                <p>Time: ${research.time} seconds</p>
                <button onclick="handleButtonClick(startResearch, '${key}')" 
                        ${canResearch ? '' : 'disabled'}>
                    ${research.unlocked ? 'Researched' : canResearch ? 'Research' : 'Locked'}
                </button>
            </div>`;
    }
    researchHTML += `</div>`;
    document.getElementById('research-panel').innerHTML = researchHTML;
}

    // =================================================================================
    // SECTION 10: UTILITIES
    // =================================================================================
    function triggerGameOver(message) { 
        gameData.gameOver = true; 
        clearInterval(gameLoopInterval); 
        document.getElementById('gameOverText').textContent = message; 
        document.getElementById('gameOverScreen').style.display = 'flex'; 
    }
    
    function showNotification(msg, color = "#0f0") { 
        const n = document.createElement("div"); 
        n.textContent = msg; 
        n.style.color = "black"; 
        n.style.background = color; 
        n.style.padding = "5px 10px"; 
        n.style.borderRadius = "5px"; 
        n.style.marginTop = "5px"; 
        document.getElementById('notifications').appendChild(n); 
        setTimeout(() => n.remove(), 4000); 
    }

    }); // This closes the DOMContentLoaded event listener
  </script>
</body>

</html>
