<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartel Tycoon: The Final Code</title>
    <style>
        :root { --main-green: #00ff00; --main-red: #ff0000; --dark-bg: #0a0a0a; --card-bg: rgba(0, 20, 0, 0.7); --border-color: #003300; --player-color: #0077ff; --ai1-color: #ff7700; --ai2-color: #ff00ff; --ai3-color: #ffff00; --ai4-color: #00ffff; --ai5-color: #ff5555; --neutral-color: #555; }
        body { font-family: 'Courier New', monospace; background: var(--dark-bg); color: var(--main-green); margin: 0; padding: 0; overflow: hidden; }
        .container { display: none; padding: 15px; max-width: 1600px; margin: 0 auto; text-align: left; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; margin-bottom: 10px; }
        .header h1 { font-size: 2rem; color: var(--main-red); text-shadow: 0 0 15px var(--main-red); margin: 0; }
        .top-stats-bar { display: flex; gap: 20px; background: var(--card-bg); padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        main { display: grid; grid-template-columns: 320px 1fr 320px; gap: 15px; height: calc(100vh - 100px); }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 0 12px rgba(0, 255, 0, 0.4); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        h2 { border-bottom: 1px solid var(--main-green); padding-bottom: 4px; margin-top: 0; margin-bottom: 8px; font-size: 1.2rem; }
        h3 { font-size: 1rem; margin: 10px 0 5px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 3px; }
        p { font-size: 0.9rem; line-height: 1.5; margin: 4px 0; }
        button { width: 100%; padding: 8px 10px; margin: 4px 0; background: var(--main-red); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s ease; box-sizing: border-box; font-size: 0.9rem; }
        button:hover { background: var(--main-green); color: #000; }
        button:disabled { background: #555; color: #999; cursor: not-allowed; opacity: 0.6; }

        .tab-buttons { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 10px; }
        .tab-link { background: none; border-radius: 6px 6px 0 0; border: 1px solid transparent; border-bottom: none; color: var(--main-green); opacity: 0.6; margin: 0 2px; flex-grow: 1; padding: 8px; font-size: 0.9rem; }
        .tab-link.active { background: var(--card-bg); border-color: var(--border-color); opacity: 1; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .item-list { overflow-y: auto; height: 100%; }
        .list-item { border-top: 1px solid var(--border-color); padding: 8px 0; margin-top: 8px; }

        #map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .territory { height: 60px; border: 2px solid #333; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; color: white; }
        .player-controlled { background-color: var(--player-color); }
        .ai-1-controlled { background-color: var(--ai1-color); } .ai-2-controlled { background-color: var(--ai2-color); } .ai-3-controlled { background-color: var(--ai3-color); } .ai-4-controlled { background-color: var(--ai4-color); } .ai-5-controlled { background-color: var(--ai5-color); }
        .neutral { background-color: var(--neutral-color); }

        #research-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .research-item { border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; }
        .progress-bar { width: 100%; background: #222; height: 10px; border: 1px solid #444; }
        .progress-fill { height: 100%; background: var(--main-green); }

        #music-player { display: flex; align-items: center; gap: 10px; background: var(--card-bg); padding: 5px 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        #song-title { font-size: 0.9rem; width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #music-player button { width: 40px; padding: 5px; }
        #youtube-player-container { display: none; }

        #menu { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: #f00; font-size: 3rem; justify-content: center; align-items: center; flex-direction: column; z-index: 1000; }
        #pauseBtn { width: 100px; background-color: #ffae00; }
        #pauseOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: #ffae00; font-size: 5rem; text-shadow: 0 0 15px #ffae00; justify-content: center; align-items: center; z-index: 999; cursor: pointer; }
        #event-modal, #territory-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { width: 500px; background: var(--dark-bg); border: 2px solid var(--main-red); padding: 20px; text-align: center; box-shadow: 0 0 30px var(--main-red); }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Cartel Tycoon</h1>
        <input type="text" id="playerName" placeholder="Enter Your Name" style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
        <div id="singlePlayerOptions">
            <label for="aiCount" style="font-size: 1.5rem; color: #0f0;">AI Opponents (1-5):</label>
            <input type="number" id="aiCount" value="3" min="1" max="5" style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
        </div>
        <button onclick="startGame('single')" style="width: 300px;">Single Player</button>
    </div>

    <div id="game" class="container">
        <header class="header">
            <h1>Cartel Tycoon</h1>
            <div id="music-player">
                <button onclick="prevSong()">⏮</button>
                <span id="song-title">Loading Music...</span>
                <button onclick="nextSong()">⏭</button>
            </div>
            <div class="top-stats-bar" id="top-stats"></div>
            <button id="pauseBtn" onclick="togglePause()">Pause</button>
        </header>
        <main>
            <div class="card" id="operations"></div>
            <div class="card" id="center-panel"></div>
            <div class="card" id="empire-stats"></div>
        </main>
    </div>
    
    <div id="notifications" style="position:fixed;top:20px;right:20px;width:300px;z-index:1001;font-weight:bold;text-align:right;"></div>
    <div id="gameOverScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);color:#f00;font-size:3rem;justify-content:center;align-items:center;flex-direction:column;z-index:1000;"><h2 id="gameOverText"></h2><button onclick="location.reload()">Start Over</button></div>
    <div id="pauseOverlay" onclick="togglePause()">PAUSED</div>
    <div id="event-modal"><div class="modal-content" id="event-content"></div></div>
    <div id="territory-modal"><div class="modal-content" id="territory-modal-content"></div></div>
    <div id="youtube-player-container"></div>
    
<script src="https://www.youtube.com/iframe_api"></script>
<script>
// =================================================================================
// SECTION 1: CORE GAME SETUP & STATE
// =================================================================================
let playerName = "";
let gameData = {};
let gameLoopInterval = null;
let isPaused = false;
let gameMode = 'single';
let currentActiveTab = 'map-panel';
let currentActiveSubTab = 'lieutenants-subpanel';
let ytPlayer;

function resetGameData(aiCount = 3) {
    gameData = {
        money: 1000, whiteMoney: 0, heat: 0,
        inventory: { weed: 10, meth: 0, coke: 0, heroin: 0, fentanyl: 0, chemicals: 0 },
        armsStock: { handgun: 0, smg: 0, rifle: 0 },
        labLevel: 0, armsTier: 0,
        personnel: { producers: 0, dealers: 0, soldiers: 0, spies: 0 },
        personnelLoyalty: 70, payrollDue: 100,
        lieutenants: [],
        territories: [],
        aiPlayers: [],
        research: {
            automation1: { name: 'Basic Automation', desc: 'Allows hiring Producers to automate drug production.', cost: 2500, time: 30, progress: 0, unlocked: false, requires: null },
            logistics1: { name: 'Faster Couriers', desc: '+10% Dealer efficiency.', cost: 10000, time: 60, progress: 0, unlocked: false, requires: 'automation1' },
            logistics2: { name: 'Smuggling Routes', desc: 'Passive heat from businesses is reduced by 25%.', cost: 75000, time: 180, progress: 0, unlocked: false, requires: 'logistics1' },
            military1: { name: 'Body Armor', desc: '+10% Soldier defense.', cost: 25000, time: 90, progress: 0, unlocked: false, requires: null },
            military2: { name: 'Assault Rifles', desc: '+15% Soldier attack power.', cost: 100000, time: 180, progress: 0, unlocked: false, requires: 'military1' },
            military3: { name: 'Fortifications', desc: 'Soldiers in your territories get a defensive bonus.', cost: 250000, time: 300, progress: 0, unlocked: false, requires: 'military2' },
            laundering1: { name: 'Shell Corps', desc: 'Businesses generate +10% Clean Money.', cost: 75000, time: 150, progress: 0, unlocked: false, requires: null },
            laundering2: { name: 'Offshore Accounts', desc: 'Unlocks a special action to slowly convert Dirty Money to Clean Money for a fee.', cost: 300000, time: 240, progress: 0, unlocked: false, requires: 'laundering1' },
        },
        researchInProgress: null,
        victory: {
            domination: { current: 0, required: 25 },
            economic: { current: 0, required: 20000000 },
            status: 'Ongoing'
        },
        gameOver: false
    };

    const territoryNames = ["Docks", "Warehouse District", "Downtown", "Suburbs", "Projects", "West Side", "East Side", "Market", "Old Town", "The Strip", "Airport", "Industrial Park", "Southside", "Northbridge", "Chinatown", "The Hills", "Financial District", "Little Italy", "Port Authority", "Union Station", "The Heights", "Riverfront", "Midtown", "Old Port", "The Slums"];
    for (let i = 0; i < 25; i++) {
        gameData.territories.push({ id: i, name: territoryNames[i], owner: 'Neutral', value: Math.floor(Math.random() * 50) + 10, soldiers: 0, business: null });
    }
    
    gameData.territories[0].owner = 'Player';
    gameData.territories[0].soldiers = 1;

    const aiNames = ["El Jefe", "La Reina", "The Ghost", "El Martillo", "La Viuda"];
    for (let i = 0; i < aiCount; i++) {
        const aiId = `AI-${i+1}`;
        gameData.territories[i + 1].owner = aiId;
        gameData.territories[i + 1].soldiers = 2;
        gameData.aiPlayers.push({ id: aiId, name: aiNames[i % aiNames.length], money: 3000, powerLevel: 1, relationship: 0, spies: 1 });
    }
}

// =================================================================================
// SECTION 2: GAME START, LOOP, & PAUSE
// =================================================================================

function startGame(mode) {
    playerName = document.getElementById('playerName').value || "Player";
    gameMode = mode;
    document.getElementById('menu').style.display = 'none';
    
    const aiCount = parseInt(document.getElementById('aiCount').value) || 3;
    document.getElementById('game').style.display = 'block';
    resetGameData(aiCount);
    isPaused = false;
    gameLoopInterval = setInterval(gameLoop, 2000);
    updateUI();
}

function gameLoop() {
    if (isPaused || gameData.gameOver) return;
    if (gameData.heat >= 200) triggerGameOver("BUSTED! The heat was too much.");
    runProduction();
    runLaundering();
    runPersonnelSystem();
    runEmpireManagement();
    runAiTurns();
    updateResearch();
    checkVictoryConditions();
    updateUI();
}

function togglePause() {
    if (gameData.gameOver) return;
    isPaused = !isPaused; 
    const pauseBtn = document.getElementById('pauseBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');
    if (isPaused) {
        clearInterval(gameLoopInterval);
        if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') ytPlayer.pauseVideo();
        pauseBtn.textContent = "Resume";
        pauseOverlay.style.display = 'flex';
    } else {
        gameLoopInterval = setInterval(gameLoop, 2000);
        if (ytPlayer && typeof ytPlayer.playVideo === 'function') ytPlayer.playVideo();
        pauseBtn.textContent = "Pause";
        pauseOverlay.style.display = 'none';
    }
}

// =================================================================================
// SECTION 3: YOUTUBE MUSIC PLAYER
// =================================================================================
function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player('youtube-player-container', {
        height: '1', width: '1',
        playerVars: { 'autoplay': 1, 'controls': 0, 'loop': 1, 'listType': 'playlist', 'list': 'OLAK5uy_k2u2jXntExJQY_M3yTcX2AMmsJJSsDBB0' },
        events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
    });
}
function onPlayerReady(event) { event.target.setVolume(50); event.target.playVideo(); }
function onPlayerStateChange(event) { if (event.data == YT.PlayerState.PLAYING) { document.getElementById('song-title').textContent = ytPlayer.getVideoData().title; } }
function nextSong() { if (ytPlayer) ytPlayer.nextVideo(); }
function prevSong() { if (ytPlayer) ytPlayer.previousVideo(); }

// =================================================================================
// SECTION 4: CORE GAMEPLAY LOOPS
// =================================================================================
function handleButtonClick(actionFn, ...args) { if (isPaused) { showNotification("Game is paused!", "orange"); return; } actionFn(...args); if (gameMode === 'single') updateUI(); }

function runProduction() {
    if (!gameData.research.automation1.unlocked) return;
    const { producers } = gameData.personnel;
    if (producers <= 0) return;
    let loyaltyBonus = 0.8 + (gameData.personnelLoyalty / 100) * 0.7;
    let labBonus = 1 + (gameData.labLevel * 0.5);
    let gain = producers * labBonus * loyaltyBonus;
    const currentDrug = getCurrentDrug();
    const chemicalsNeeded = currentDrug === 'weed' ? 0 : producers;
    if (gameData.inventory.chemicals >= chemicalsNeeded) {
        gameData.inventory.chemicals -= chemicalsNeeded;
        gameData.inventory[currentDrug] += gain;
    } else {
        showNotification("Production halted, not enough chemicals!", "orange");
    }
}

function runLaundering() {
    let totalIncome = 0;
    const drugPrices = { "weed": 10, "meth": 25, "coke": 60, "heroin": 150, "fentanyl": 400 };
    gameData.territories.forEach(t => {
        if (t.owner === 'Player' && t.business) {
            let capacity = t.business.capacity;
            let laundered = 0;
            let heatReduction = gameData.research.logistics2.unlocked ? 0.75 : 1;
            for (const drugType in gameData.inventory) {
                if (drugType === 'chemicals' || laundered >= capacity || drugPrices[drugType] === undefined) continue;
                let sellAmount = Math.min(gameData.inventory[drugType], capacity - laundered);
                if (sellAmount > 0) {
                    laundered += sellAmount;
                    gameData.inventory[drugType] -= sellAmount;
                    totalIncome += sellAmount * drugPrices[drugType];
                }
            }
            gameData.heat += laundered * t.business.heatFactor * heatReduction;
        }
    });
    if (gameData.research.laundering1.unlocked) { totalIncome *= 1.1; }
    gameData.whiteMoney += totalIncome;
}

function runPersonnelSystem() {
    const totalPersonnel = gameData.personnel.producers + gameData.personnel.dealers + gameData.personnel.soldiers;
    if (totalPersonnel <= 0) return;
    gameData.payrollDue--;
    if (gameData.payrollDue <= 0) {
        let payrollCost = (gameData.personnel.producers * 20) + (gameData.personnel.dealers * 30) + (gameData.personnel.soldiers * 50);
        if (gameData.money >= payrollCost) {
            gameData.money -= payrollCost;
            gameData.personnelLoyalty = Math.min(100, gameData.personnelLoyalty + 5);
        } else {
            gameData.personnelLoyalty -= 20;
            showNotification("CAN'T PAY PAYROLL! Morale has plummeted!", "red");
        }
        gameData.payrollDue = 50;
    }
    gameData.personnelLoyalty -= 0.05;
    if (gameData.personnelLoyalty <= 0) {
        gameData.heat += 50;
        if (gameData.personnel.soldiers > 0) gameData.personnel.soldiers--;
        else if (gameData.personnel.dealers > 0) gameData.personnel.dealers--;
        else if (gameData.personnel.producers > 0) gameData.personnel.producers--;
        gameData.personnelLoyalty = 20;
        showNotification("A crew member snitched and quit! MASSIVE heat increase!", "red");
    }
}

function runEmpireManagement() {
    if (Math.random() < 0.05) triggerRandomEvent();
}

// =================================================================================
// SECTION 5: PLAYER ACTIONS
// =================================================================================
function produceWeedManually() { gameData.inventory.weed += 1; }
function sellWeedManually() { if (gameData.inventory.weed > 0) { gameData.inventory.weed--; gameData.money += 10; gameData.heat += 0.1; } }

function hirePersonnel(type) {
    const costs = { producer: 200, dealer: 500, soldier: 1000, lieutenant: 50000, spy: 25000 };
    if (type === 'producer' && !gameData.research.automation1.unlocked) {
        showNotification("Research 'Basic Automation' to hire Producers.", "orange");
        return;
    }
    if (gameData.money < costs[type]) { showNotification("Not enough cash.", "red"); return; }
    
    gameData.money -= costs[type];
    if (type === 'lieutenant') {
        const names = ["'El Perro'", "'La Gata'", "'El Martillo'", "'Silencioso'", "'La Sombra'"];
        gameData.lieutenants.push({ name: names[gameData.lieutenants.length % names.length], assignedTerritory: -1 });
    } else {
        gameData.personnel[type + 's']++;
    }
}

function upgradeLab() {
    const costs = [5000, 25000, 100000, 500000];
    if (gameData.labLevel >= costs.length) { showNotification("Lab is max level.", "orange"); return; }
    let cost = costs[gameData.labLevel];
    if (gameData.money < cost) { showNotification(`Need $${cost} to upgrade.`, "red"); return; }
    gameData.money -= cost;
    gameData.labLevel++;
    showNotification(`Lab upgraded to Tier ${gameData.labLevel}! Production of '${getCurrentDrug()}' is now possible.`, "lightgreen");
}

function upgradeWorkshop() {
    const costs = [15000, 75000, 300000];
    if (gameData.armsTier >= costs.length) { showNotification("Workshop is max level.", "orange"); return; }
    let cost = costs[gameData.armsTier];
    if (gameData.money < cost) { showNotification(`Need $${cost} to upgrade.`, "red"); return; }
    gameData.money -= cost;
    gameData.armsTier++;
    showNotification(`Arms Workshop upgraded to Tier ${gameData.armsTier}.`, "lightgreen");
}

function manufactureArms() {
    const costs = { 1: 500, 2: 2500, 3: 10000 }, arms = { 1: "handgun", 2: "smg", 3: "rifle" }, heat = { 1: 20, 2: 50, 3: 100 };
    let tier = gameData.armsTier;
    if (tier === 0) { showNotification("You need an Arms Workshop first.", "orange"); return; }
    if (gameData.money < costs[tier]) { showNotification("Not enough cash for parts.", "red"); return; }
    gameData.money -= costs[tier];
    gameData.armsStock[arms[tier]]++;
    gameData.heat += heat[tier];
}

function sellArms() {
    const prices = { handgun: 750, smg: 4000, rifle: 15000 };
    let totalSale = 0;
    for (const arm in gameData.armsStock) {
        if (gameData.armsStock[arm] > 0) {
            totalSale += gameData.armsStock[arm] * prices[arm];
            gameData.armsStock[arm] = 0;
        }
    }
    if (totalSale > 0) { gameData.money += totalSale; }
}

function attackTerritory(territoryId) { /* (Unchanged) */ }
function openTerritoryModal(territoryId) { /* (Unchanged) */ }
function closeModal(modalId) { /* (Unchanged) */ }
function buildBusiness(territoryId, type) { /* (Unchanged) */ }
function assignLieutenant(ltIndex) { /* (Unchanged) */ }

// =================================================================================
// SECTION 6: ESPIONAGE, EVENTS, AI, DIPLOMACY
// =================================================================================
function launchSpyMission(targetAiIndex, missionType) { /* (Unchanged) */ }
const events = [ /* (Unchanged) */ ];
function triggerRandomEvent() { /* (Unchanged) */ }
function resolveEvent(action) { /* (Unchanged) */ }
function runAiTurns() { /* (Unchanged) */ }
function proposeDeal(aiIndex) { /* (Unchanged) */ }


// =================================================================================
// SECTION 7: RESEARCH & DEVELOPMENT
// =================================================================================
function startResearch(researchId) {
    if (gameData.researchInProgress) { showNotification("Another research project is already in progress.", "orange"); return; }
    const research = gameData.research[researchId];
    if (research.unlocked) return;
    if (research.requires && !gameData.research[research.requires].unlocked) { showNotification("Requires previous technology.", "red"); return; }
    if (gameData.whiteMoney < research.cost) { showNotification(`Need $${research.cost} in CLEAN money to start research.`, "red"); return; }
    gameData.whiteMoney -= research.cost;
    gameData.researchInProgress = researchId;
}

function updateResearch() {
    if (!gameData.researchInProgress) return;
    const researchId = gameData.researchInProgress;
    const research = gameData.research[researchId];
    research.progress += 2;
    if (research.progress >= research.time) {
        research.unlocked = true;
        gameData.researchInProgress = null;
        showNotification(`Research Complete: ${research.name}!`, "lightgreen");
    }
}


// =================================================================================
// SECTION 8: VICTORY CONDITIONS
// =================================================================================
function checkVictoryConditions() {
    const playerTerritories = gameData.territories.filter(t => t.owner === 'Player').length;
    gameData.victory.domination.current = playerTerritories;
    if (playerTerritories >= gameData.victory.domination.required) {
        triggerGameOver("DOMINATION VICTORY! You control the entire city.");
    }
    gameData.victory.economic.current = gameData.whiteMoney;
    if (gameData.whiteMoney >= gameData.victory.economic.required) {
        triggerGameOver("ECONOMIC VICTORY! You have successfully laundered your empire into legitimacy.");
    }
}

// =================================================================================
// SECTION 9: UI RENDERING
// =================================================================================
function showTab(tabName, event) {
    currentActiveTab = tabName;
    updateUI();
}
function showSubTab(tabName, event) {
    currentActiveSubTab = tabName;
    updateUI();
}

function updateUI() {
    if (!gameData || gameData.gameOver) return;
    
    document.getElementById('top-stats').innerHTML = `<p>💰 Dirty: $${Math.floor(gameData.money)}</p> <p>💵 Clean: $${Math.floor(gameData.whiteMoney)}</p> <p>🔥 Heat: ${Math.floor(gameData.heat)}</p>`;
    
    let opsHTML = `<h2>Operations</h2><div class="item-list">`;
    if (!gameData.research.automation1.unlocked) {
        opsHTML += `<h3>Manual Operation</h3><button onclick="handleButtonClick(produceWeedManually)">Produce Weed (+1)</button><button onclick="handleButtonClick(sellWeedManually)">Sell Weed ($10)</button><hr>`;
    }
    opsHTML += `<h3>Drug Operation</h3><p>Current Production Tier: ${getCurrentDrug()}</p><button onclick="handleButtonClick(upgradeLab)">Upgrade Lab</button>`;
    opsHTML += `<h3>Arms Trafficking</h3><p>Workshop Tier: ${gameData.armsTier}</p><button onclick="handleButtonClick(upgradeWorkshop)">Upgrade Workshop</button><button onclick="handleButtonClick(manufactureArms)">Manufacture Arms</button><button onclick="handleButtonClick(sellArms)">Sell All Arms</button></div>`;
    document.getElementById('operations').innerHTML = opsHTML;
    
    document.getElementById('center-panel').innerHTML = `<div class="tab-buttons"> <button class="tab-link" onclick="showTab('map-panel', event)">Map</button> <button class="tab-link" onclick="showTab('management-panel', event)">Management</button> <button class="tab-link" onclick="showTab('research-panel', event)">Research</button> </div> <div id="map-panel" class="tab-content"></div> <div id="management-panel" class="tab-content"></div> <div id="research-panel" class="tab-content"></div>`;
    
    let loyaltyColor = gameData.personnelLoyalty > 60 ? 'lightgreen' : gameData.personnelLoyalty > 30 ? 'orange' : 'red';
    let statsHTML = `<h2>Empire Stats</h2> <div class="item-list"><h3>Personnel</h3> <p><strong>Morale: <span style="color:${loyaltyColor};">${gameData.personnelLoyalty.toFixed(1)}%</span></strong></p> <p>Next Payroll: ${gameData.payrollDue}s</p>`;
    statsHTML += `<p>Producers: ${gameData.personnel.producers}</p> <button onclick="handleButtonClick(hirePersonnel, 'producer')" ${!gameData.research.automation1.unlocked ? 'disabled' : ''}>Hire Producer ($200)</button>`;
    statsHTML += `<p>Dealers: ${gameData.personnel.dealers}</p> <button onclick="handleButtonClick(hirePersonnel, 'dealer')">Hire Dealer ($500)</button> <p>Soldiers: ${gameData.personnel.soldiers}</p> <button onclick="handleButtonClick(hirePersonnel, 'soldier')">Hire Soldier ($1000)</button><p>Spies: ${gameData.personnel.spies}</p><hr><h3>Inventory</h3>`;
    for(const item in gameData.inventory) { statsHTML += `<p>${item.charAt(0).toUpperCase() + item.slice(1)}: ${Math.floor(gameData.inventory[item])}</p>`; }
    statsHTML += `<hr><h3>Victory Progress</h3><p>Domination: ${gameData.victory.domination.current}/${gameData.victory.domination.required}</p><p>Economic: $${Math.floor(gameData.victory.economic.current)}/$${gameData.victory.economic.required}</p></div>`;
    document.getElementById('empire-stats').innerHTML = statsHTML;
    
    let mapHTML = `<h2>City Map</h2><div id="map-grid">`;
    const ownerColors = {'Player': 'player', 'AI-1': 'ai-1', 'AI-2': 'ai-2', 'AI-3': 'ai-3', 'AI-4': 'ai-4', 'AI-5': 'ai-5', 'Neutral': 'neutral'};
    gameData.territories.forEach(t => { mapHTML += `<div class="territory ${ownerColors[t.owner]}-controlled" onclick="handleButtonClick(openTerritoryModal, ${t.id})"><span>${t.name}</span><span>${t.business ? '🏢' : ''} ⚔️ ${t.soldiers}</span></div>`; });
    mapHTML += `</div>`;
    document.getElementById('map-panel').innerHTML = mapHTML;

    document.getElementById('management-panel').innerHTML = `<div class="tab-buttons"><button class="tab-link" onclick="showSubTab('lieutenants-subpanel', event)">Lieutenants</button><button class="tab-link" onclick="showSubTab('diplomacy-subpanel', event)">Diplomacy</button><button class="tab-link" onclick="showSubTab('espionage-subpanel', event)">Espionage</button></div><div id="lieutenants-subpanel" class="tab-content item-list"></div><div id="diplomacy-subpanel" class="tab-content item-list"></div><div id="espionage-subpanel" class="tab-content item-list"></div>`;
    
    let lieutenantsHTML = `<h3>Lieutenants</h3><button onclick="handleButtonClick(hirePersonnel, 'lieutenant')">Hire Lieutenant ($50,000)</button>`;
    // ... lieutenants rendering
    document.getElementById('lieutenants-subpanel').innerHTML = lieutenantsHTML;

    let diplomacyHTML = `<h3>Rival Leaders</h3>`;
    // ... diplomacy rendering
    document.getElementById('diplomacy-subpanel').innerHTML = diplomacyHTML;
    
    let espionageHTML = `<h3>Espionage</h3><p>Spies Available: ${gameData.personnel.spies}</p><button onclick="handleButtonClick(hirePersonnel, 'spy')">Hire Spy ($25,000)</button><hr/>`;
    // ... espionage rendering
    document.getElementById('espionage-subpanel').innerHTML = espionageHTML;
    
    let researchHTML = `<h2>Research & Development</h2><div id="research-grid">`;
    // ... research rendering
    document.getElementById('research-panel').innerHTML = researchHTML;
    
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('#center-panel > .tab-buttons > .tab-link').forEach(link => link.classList.remove('active'));
    document.getElementById(currentActiveTab).style.display = 'block';
    const activeLink = document.querySelector(`.tab-link[onclick^="showTab('${currentActiveTab}'"]`);
    if(activeLink) activeLink.classList.add('active');
    
    if(currentActiveTab === 'management-panel') {
        document.querySelectorAll('.sub-tab-content').forEach(tab => tab.style.display = 'none');
        document.querySelectorAll('#management-panel .tab-link').forEach(link => link.classList.remove('active'));
        document.getElementById(currentActiveSubTab).style.display = 'block';
        const activeSubLink = document.querySelector(`.tab-link[onclick^="showSubTab('${currentActiveSubTab}'"]`);
        if(activeSubLink) activeSubLink.classList.add('active');
    }
}

// =================================================================================
// SECTION 10: UTILITIES
// =================================================================================
function getCurrentDrug() {
    const drugTiers = ["weed", "meth", "coke", "heroin", "fentanyl"];
    return drugTiers[gameData.labLevel] || "weed";
}
// ... other utilities
</script>
</body>
</html>
