<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartel Tycoon: Enhanced Edition</title>
    <style>
        :root {
            --main-green: #00ff00;
            --main-red: #ff0000;
            --dark-bg: #0a0a0a;
            --card-bg: rgba(0, 20, 0, 0.7);
            --border-color: #003300;
            --player-color: #0077ff;
            --ai1-color: #ff7700;
            --ai2-color: #ff00ff;
            --ai3-color: #ffff00;
            --neutral-color: #555;
            --ui-scale: 1;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: var(--dark-bg);
            color: var(--main-green);
            margin: 0;
            padding: 0;
            overflow: hidden;
            transform: scale(var(--ui-scale));
            transform-origin: top left;
            width: calc(100vw / var(--ui-scale));
            height: calc(100vh / var(--ui-scale));
        }

        #main-menu {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            color: #f00;
            font-size: 2rem;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
}

        .menu-section {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
}

        .menu-section {
            background: rgba(0, 20, 0, 0.8);
            border: 2px solid #0f0;
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            width: 400px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .menu-title {
            font-size: 2.5rem;
            color: #f00;
            text-shadow: 0 0 10px #f00;
            margin-bottom: 20px;
        }

        .menu-option {
            margin: 15px 0;
        }

        .menu-option label {
            display: block;
            margin-bottom: 5px;
            font-size: 1.2rem;
            color: #0f0;
        }

        .menu-option input, .menu-option select {
            width: 80%;
            padding: 10px;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .menu-buttons button {
            font-size: 1.2rem;
            padding: 12px;
        }

        .minecraft-button {
            background: #727272;
            color: white;
            border: 2px solid #000;
            border-radius: 0;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px #000;
            box-shadow: inset 2px 2px #fff9, inset -2px -2px #0006;
            transition: all 0.1s;
            cursor: pointer;
        }

        .minecraft-button:hover {
            background: #828282;
            transform: translateY(-1px);
        }

        .minecraft-button:active {
            box-shadow: inset 2px 2px #0006, inset -2px -2px #fff9;
            transform: translateY(1px);
        }

        .minecraft-input {
            background: #727272;
            color: white;
            border: 2px solid #000;
            border-radius: 0;
            padding: 8px;
            font-family: 'Courier New', monospace;
            text-shadow: 1px 1px #000;
            box-shadow: inset 2px 2px #0006, inset -2px -2px #fff9;
        }

        .container {
            display: none;
            width: 100vw;
            height: 100vh;
            padding: 10px;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            margin-bottom: 5px;
            height: 10vh;
        }

        .header h1 {
            font-size: calc(1.5rem * var(--ui-scale));
            color: var(--main-red);
            text-shadow: 0 0 10px var(--main-red);
            margin: 0;
        }

        .top-stats-bar {
            display: flex;
            gap: 10px;
            background: var(--card-bg);
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: calc(0.8rem * var(--ui-scale));
            flex-wrap: wrap;
            max-width: 50%;
        }

        main {
            display: grid;
            grid-template-columns: 25% 50% 25%;
            gap: 10px;
            height: 80vh;
        }

        .card {
            background: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.4);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        h2 {
            border-bottom: 1px solid var(--main-green);
            padding-bottom: 3px;
            margin-top: 0;
            margin-bottom: 5px;
            font-size: calc(1rem * var(--ui-scale));
        }

        h3 {
            font-size: calc(0.9rem * var(--ui-scale));
            margin: 5px 0 3px 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2px;
        }

        p {
            font-size: calc(0.8rem * var(--ui-scale));
            line-height: 1.3;
            margin: 2px 0;
        }

        button {
            padding: 5px 8px;
            margin: 3px 0;
            background: var(--main-red);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: calc(0.8rem * var(--ui-scale));
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 5px;
            overflow-x: auto;
        }

        .tab-link {
            background: none;
            border-radius: 4px 4px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
            color: var(--main-green);
            opacity: 0.6;
            margin: 0 1px;
            flex-grow: 1;
            padding: 5px;
            font-size: calc(0.8rem * var(--ui-scale));
            min-width: max-content;
        }

        .tab-link.active {
            background: var(--card-bg);
            border-color: var(--border-color);
            opacity: 1;
        }

        .tab-content {
            display: none;
            flex-grow: 1;
            overflow: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .item-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        .list-item {
            border-top: 1px solid var(--border-color);
            padding: 5px 0;
            margin-top: 5px;
        }

        #map-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
        }

        .territory {
            height: 50px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2px;
            font-size: calc(0.7rem * var(--ui-scale));
            cursor: pointer;
        }

        .player-controlled { background-color: var(--player-color); }
        .ai-1-controlled { background-color: var(--ai1-color); }
        .ai-2-controlled { background-color: var(--ai2-color); }
        .ai-3-controlled { background-color: var(--ai3-color); }
        .neutral-controlled { background-color: var(--neutral-color); }

        #music-player {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--card-bg);
            padding: 3px 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: calc(0.8rem * var(--ui-scale));
        }

        #song-title {
            width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #music-player button {
            width: 30px;
            padding: 3px;
        }

        #ui-scale-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #ui-scale-controls label {
            font-size: calc(0.8rem * var(--ui-scale));
        }

        #ui-scale-slider {
            width: 80px;
        }

        #turn-timer {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: var(--card-bg);
            padding: 5px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: calc(0.8rem * var(--ui-scale));
        }

        #turn-progress {
            width: 80px;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        #turn-progress-bar {
            height: 100%;
            background: var(--main-green);
            width: 0%;
            transition: width 1s linear;
        }

        #notifications {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 250px;
            z-index: 1001;
            font-weight: bold;
            text-align: right;
            font-size: calc(0.8rem * var(--ui-scale));
        }

        #gameOverScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            color: #0f0;
            font-size: 2rem;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
        }

        #pauseOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            color: #ffae00;
            font-size: 3rem;
            text-shadow: 0 0 15px #ffae00;
            justify-content: center;
            align-items: center;
            z-index: 999;
            cursor: pointer;
        }

        .indicator {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        
        .indicator-label {
            width: 100px;
        }
        
        .indicator-bar {
            flex-grow: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 0 5px;
        }
        
        .indicator-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .indicator-value {
            width: 40px;
            text-align: right;
        }

        .market-card {
            background: rgba(0, 30, 0, 0.8);
            border: 1px solid #005500;
            border-radius: 5px;
            padding: 5px;
            margin-bottom: 5px;
        }
        
        .resource-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 3px 0;
        }
        
        .resource-name {
            width: 60px;
        }
        
        .resource-price {
            width: 60px;
            text-align: right;
        }

        .bank-account {
            border: 1px solid #555;
            border-radius: 4px;
            padding: 5px;
            margin-bottom: 5px;
        }

        .save-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: rgba(0, 30, 0, 0.6);
            border: 1px solid #0f0;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .save-info {
            text-align: left;
            flex-grow: 1;
        }

        .save-actions {
            display: flex;
            gap: 3px;
        }

        .save-actions button {
            width: auto;
            padding: 3px 6px;
        }

        #youtube-player-container {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="main-menu">
        <div class="menu-title">CARTEL TYCOON</div>
        
        <div class="menu-section" id="game-type-section">
            <h2>Select Game Type</h2>
            <div class="menu-buttons">
                <button class="minecraft-button" onclick="showMenuSection('singleplayer-setup')">Single Player</button>
                <button class="minecraft-button" onclick="showMenuSection('multiplayer-setup')">Multiplayer</button>
                <button class="minecraft-button" onclick="showMenuSection('load-game')">Load Game</button>
            </div>
        </div>

        <!-- Single Player Setup -->
        <div class="menu-section" id="singleplayer-setup" style="display: none;">
            <h2>Single Player Setup</h2>
            <div class="menu-option">
                <label for="gangNameSingle">Your Gang Name:</label>
                <input class="minecraft-input" type="text" id="gangNameSingle" placeholder="Enter Gang Name">
            </div>
            <div class="menu-option">
                <label for="gameMode">Game Mode:</label>
                <select class="minecraft-input" id="gameMode">
                    <option value="standard">Standard</option>
                    <option value="sandbox">Sandbox (Unlimited Money)</option>
                    <option value="creative">Creative (No Enemies)</option>
                </select>
            </div>
            <div class="menu-option">
                <label for="aiCount">AI Opponents (1-3):</label>
                <input class="minecraft-input" type="number" id="aiCount" value="2" min="1" max="3">
            </div>
            <div class="menu-option">
                <label for="economyDifficulty">Economic Difficulty:</label>
                <select class="minecraft-input" id="economyDifficulty">
                    <option value="easy">Easy</option>
                    <option value="medium" selected>Medium</option>
                    <option value="hard">Hard</option>
                    <option value="realistic">Realistic</option>
                </select>
            </div>
            <div class="menu-buttons">
                <button class="minecraft-button" onclick="startGame('singleplayer')">Start Game</button>
                <button class="minecraft-button" onclick="showMenuSection('game-type-section')">Back</button>
            </div>
        </div>

        <!-- Load Game Section -->
        <div class="menu-section" id="load-game" style="display: none;">
            <h2>Load Saved Game</h2>
            <div id="save-slots">
                <p>Loading saved games...</p>
            </div>
            <div class="menu-buttons">
                <button class="minecraft-button" onclick="showMenuSection('game-type-section')">Back</button>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="game" class="container">
        <header class="header">
            <h1 id="gang-title">Cartel Tycoon</h1>
            <div id="music-player">
                <button onclick="prevSong()">⏮</button>
                <span id="song-title">Loading Music...</span>
                <button onclick="nextSong()">⏭</button>
            </div>
            <div class="top-stats-bar" id="top-stats"></div>
            <div>
                <button id="saveBtn" onclick="saveGame()">Save</button>
                <button id="endTurnBtn" onclick="endTurn()">End Turn</button>
                <button id="pauseBtn" onclick="togglePause()">Pause</button>
            </div>
        </header>
        <main>
            <div class="card" id="operations"></div>
            <div class="card" id="center-panel"></div>
            <div class="card" id="personnel-inventory"></div>
        </main>
    </div>

    <div id="notifications"></div>
    <div id="gameOverScreen">
        <h2 id="gameOverText"></h2>
        <button onclick="location.reload()">Start Over</button>
        <button onclick="returnToMenu()">Return to Menu</button>
    </div>
    <div id="pauseOverlay">PAUSED</div>

    <!-- UI Scale Controls -->
    <div id="ui-scale-controls">
        <label for="ui-scale-slider">UI Scale:</label>
        <input type="range" id="ui-scale-slider" min="0.7" max="1.3" step="0.1" value="1">
        <span id="ui-scale-value">100%</span>
    </div>

    <!-- Turn Timer -->
    <div id="turn-timer">
        <div>Time Left:</div>
        <div id="turn-progress">
            <div id="turn-progress-bar"></div>
        </div>
        <div id="time-left">25s</div>
    </div>

    <div id="youtube-player-container"></div>

    <script>
        // Global game variables
        let playerName = "";
        let gangName = "";
        let gameMode = "standard";
        let gameData = {};
        let gameLoopInterval = null;
        let isPaused = false;
        let currentActiveTab = 'map-panel';
        let economyDifficulty = 'medium';
        let turnTime = 25;
        let turnTimeLeft = turnTime;
        let turnTimer = null;
        let ytPlayer;

        // Menu navigation functions
        function showMenuSection(sectionId) {
            document.querySelectorAll('.menu-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
            if (sectionId === 'load-game') {
                loadSaveSlots();
            }
        }

        // UI Scale functionality
        function setupUIScaling() {
            const slider = document.getElementById('ui-scale-slider');
            slider.addEventListener('input', function(e) {
                const scaleValue = e.target.value;
                document.documentElement.style.setProperty('--ui-scale', scaleValue);
                document.getElementById('ui-scale-value').textContent = Math.round(scaleValue * 100) + '%';
            });
            
            // Set initial scale based on device
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                slider.value = 0.8;
                document.documentElement.style.setProperty('--ui-scale', 0.8);
                document.getElementById('ui-scale-value').textContent = '80%';
            }
        }

        // YouTube Music Player
        function initMusicPlayer() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        window.onYouTubeIframeAPIReady = function() {
            ytPlayer = new YT.Player('youtube-player-container', {
                height: '1',
                width: '1',
                playerVars: {
                    'autoplay': 1,
                    'controls': 0,
                    'loop': 1,
                    'listType': 'playlist',
                    'list': 'OLAK5uy_k2u2jXntExJQY_M3yTcX2AMmsJJSsDBB0'
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            event.target.setVolume(30);
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                document.getElementById('song-title').textContent = ytPlayer.getVideoData().title;
            }
        }

        function nextSong() {
            if (ytPlayer) ytPlayer.nextVideo();
        }

        function prevSong() {
            if (ytPlayer) ytPlayer.previousVideo();
        }

        // Save game system
        function saveGame() {
            if (!gameData || Object.keys(gameData).length === 0) {
                showNotification("No game data to save!", "red");
                return;
            }
            
            const saveData = {
                gameData: gameData,
                timestamp: Date.now(),
                gangName: gangName,
                gameMode: gameMode,
                playerName: playerName
            };
            
            const saveSlot = `save_${Date.now()}`;
            localStorage.setItem(saveSlot, JSON.stringify(saveData));
            localStorage.setItem('latestSave', saveSlot);
            
            showNotification("Game saved successfully!", "lightgreen");
        }

        function loadGame(saveSlot) {
            const saveData = localStorage.getItem(saveSlot);
            if (!saveData) {
                showNotification("No saved game found!", "red");
                return;
            }
            
            try {
                const parsedData = JSON.parse(saveData);
                gameData = parsedData.gameData;
                gangName = parsedData.gangName;
                gameMode = parsedData.gameMode;
                playerName = parsedData.playerName;
                
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                document.getElementById('gang-title').textContent = gangName;
                
                isPaused = false;
                startTurnTimer();
                updateUI();
                
                showNotification("Game loaded successfully!", "lightgreen");
            } catch (error) {
                showNotification("Failed to load game: " + error.message, "red");
            }
        }

        function loadSaveSlots() {
            const saveSlotsContainer = document.getElementById('save-slots');
            saveSlotsContainer.innerHTML = '';
            
            const saves = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('save_')) {
                    try {
                        const saveData = JSON.parse(localStorage.getItem(key));
                        saves.push({
                            key: key,
                            timestamp: saveData.timestamp,
                            gangName: saveData.gangName,
                            gameMode: saveData.gameMode
                        });
                    } catch (e) {
                        console.error("Error parsing save data:", e);
                    }
                }
            }
            
            saves.sort((a, b) => b.timestamp - a.timestamp);
            
            if (saves.length === 0) {
                saveSlotsContainer.innerHTML = '<p>No saved games found</p>';
                return;
            }
            
            saves.forEach(save => {
                const saveDate = new Date(save.timestamp);
                const saveElement = document.createElement('div');
                saveElement.className = 'save-slot';
                saveElement.innerHTML = `
                    <div class="save-info">
                        <strong>${save.gangName}</strong>
                        <div>${saveDate.toLocaleString()}</div>
                        <div>Mode: ${save.gameMode}</div>
                    </div>
                    <div class="save-actions">
                        <button onclick="loadGame('${save.key}')">Load</button>
                        <button onclick="deleteSave('${save.key}')">Delete</button>
                    </div>
                `;
                saveSlotsContainer.appendChild(saveElement);
            });
        }

        function deleteSave(saveKey) {
            if (confirm("Are you sure you want to delete this saved game?")) {
                localStorage.removeItem(saveKey);
                loadSaveSlots();
                showNotification("Save game deleted", "orange");
            }
        }

        function returnToMenu() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }
            
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
            
            document.getElementById('game').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
            showMenuSection('game-type-section');
        }

        // Turn timer system
        function startTurnTimer() {
            turnTimeLeft = turnTime;
            updateTurnTimer();
            
            if (turnTimer) {
                clearInterval(turnTimer);
            }
            
            turnTimer = setInterval(() => {
                if (!isPaused && !gameData.gameOver) {
                    turnTimeLeft--;
                    updateTurnTimer();
                    
                    if (turnTimeLeft <= 0) {
                        endTurn();
                    }
                }
            }, 1000);
        }
        
        function updateTurnTimer() {
            const progressPercent = (turnTimeLeft / turnTime) * 100;
            document.getElementById('turn-progress-bar').style.width = progressPercent + '%';
            document.getElementById('time-left').textContent = turnTimeLeft + 's';
        }
        
        function endTurn() {
            if (isPaused || gameData.gameOver) return;
            
            gameLoop();
            startTurnTimer();
            showNotification("Turn completed", "lightblue");
        }

        // Game initialization
        function startGame(type) {
            if (type === 'singleplayer') {
                gangName = document.getElementById('gangNameSingle').value || "My Gang";
                gameMode = document.getElementById('gameMode').value;
                economyDifficulty = document.getElementById('economyDifficulty').value;
                
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                document.getElementById('gang-title').textContent = gangName;
                
                const aiCount = parseInt(document.getElementById('aiCount').value) || 2;
                resetGameData(aiCount);
                isPaused = false;
                startTurnTimer();
                updateUI();
            }
        }

        function resetGameData(aiCount = 2) {
            gameData = {
                money: gameMode === "sandbox" ? 999999 : 10000,
                whiteMoney: 0,
                heat: 0,
                reputation: 50,
                inflation: 0,
                economicStability: 75,
                marketDemand: { weed: 70, meth: 40, coke: 25, heroin: 15, fentanyl: 5 },
                marketPrices: { weed: 15, meth: 60, coke: 250, heroin: 600, fentanyl: 1800 },
                priceVolatility: { weed: 0.1, meth: 0.15, coke: 0.2, heroin: 0.25, fentanyl: 0.3 },
                inventory: { weed: 20, meth: 0, coke: 0, heroin: 0, fentanyl: 0, chemicals: 0 },
                productionCapacity: { weed: 5, meth: 0, coke: 0, heroin: 0, fentanyl: 0 },
                distributionNetworks: 1,
                transportation: { vehicles: 2, efficiency: 0.8 },
                armsStock: { handgun: 0, smg: 0, rifle: 0 },
                labLevel: 0,
                armsTier: 0,
                currentDrug: "weed",
                personnel: { producers: 2, dealers: 3, soldiers: gameMode === "creative" ? 10 : 2, spies: 0, accountants: 0 },
                lieutenants: [],
                properties: [],
                personnelLoyalty: 75,
                territories: [],
                aiPlayers: gameMode === "creative" ? [] : [],
                loans: [],
                investments: [],
                research: {
                    logistics1: { name: 'Faster Couriers', desc: '+15% Dealer efficiency.', cost: 10000, time: 60, progress: 0, unlocked: false, requires: null },
                    logistics2: { name: 'Bulk Chemicals', desc: 'Chemical costs reduced by 20%.', cost: 50000, time: 120, progress: 0, unlocked: false, requires: 'logistics1' },
                    military1: { name: 'Body Armor', desc: '+10% Soldier defense.', cost: 25000, time: 90, progress: 0, unlocked: false, requires: null },
                    military2: { name: 'Assault Rifles', desc: '+15% Soldier attack power.', cost: 100000, time: 180, progress: 0, unlocked: false, requires: 'military1' },
                    laundering1: { name: 'Shell Corps', desc: 'Lieutenants take a smaller cut.', cost: 75000, time: 150, progress: 0, unlocked: false, requires: null },
                    laundering2: { name: 'Offshore Accounts', desc: 'Money laundering efficiency +25%.', cost: 200000, time: 200, progress: 0, unlocked: false, requires: 'laundering1' },
                    market1: { name: 'Market Analysis', desc: 'See market trends and predictions.', cost: 30000, time: 100, progress: 0, unlocked: false, requires: null }
                },
                researchInProgress: null,
                victory: { domination: { current: 0, required: 15 }, economic: { current: 0, required: 5000000 }, status: 'Ongoing' },
                gangs: [
                    { name: "Local Thugs", drug: "weed", strength: 1 },
                    { name: "Street Gangs", drug: "meth", strength: 2 },
                    { name: "Big City Gangs", drug: "coke", strength: 3 },
                    { name: "Cartel", drug: "heroin", strength: 4 },
                    { name: "Super Cartel", drug: "fentanyl", strength: 5 }
                ],
                gameOver: false,
                drugEarningCaps: { weed: 10000, meth: 50000, coke: 200000, heroin: 800000, fentanyl: 3000000 },
                drugEarnings: { weed: 0, meth: 0, coke: 0, heroin: 0, fentanyl: 0 },
                manualProduction: { weed: { progress: 0, time: 10 } },
                economicEvents: [],
                lastMarketUpdate: 0,
                economicCycles: { boom: false, recession: false, duration: 0 },
                bankAccounts: { local: { balance: 0, seizureRisk: 0.1 }, offshore: { balance: 0, seizureRisk: 0.02, transferFee: 0.05 } },
                stocks: {
                    "PharmaCorp": { price: 100, owned: 0, volatility: 0.15 },
                    "AgriGrow": { price: 50, owned: 0, volatility: 0.2 },
                    "ChemiCo": { price: 75, owned: 0, volatility: 0.25 },
                    "SecureTrans": { price: 120, owned: 0, volatility: 0.1 }
                },
                resourcePrices: { chemicals: 50, equipment: 200, vehicles: 5000 },
                equipment: { labs: { count: 1, condition: 100 }, vehicles: { count: 2, condition: 100 }, weapons: { count: 5, condition: 100 } }
            };

            // Initialize territories
            const territoryNames = ["Docks", "Warehouse District", "Downtown", "Suburbs", "Projects", "West Side", "East Side", "Market", "Old Town", "The Strip", "Airport", "Industrial Park", "Southside", "Northbridge", "Chinatown"]; 
            for (let i = 0; i < 15; i++) { 
                const economicValue = Math.floor(Math.random() * 100) + 50;
                const population = Math.floor(Math.random() * 500) + 200;
                gameData.territories.push({ 
                    id: i, 
                    name: territoryNames[i], 
                    owner: 'Neutral', 
                    value: economicValue,
                    population: population,
                    economicStatus: Math.random() > 0.5 ? 'Stable' : 'Unstable',
                    soldiers: Math.floor(Math.random() * 4), 
                    lieutenant: -1, 
                    business: null 
                });
            } 
            
            // Initialize AI players
            if (gameMode !== "creative") {
                const aiNames = ["El Jefe", "La Reina", "The Ghost"]; 
                for (let i = 0; i < aiCount; i++) { 
                    const aiId = `AI-${i + 1}`; 
                    gameData.aiPlayers.push({ 
                        id: aiId, 
                        name: aiNames[i], 
                        money: 10000, 
                        powerLevel: 1, 
                        relationship: Math.floor(Math.random() * 40) - 20, 
                        spies: 1,
                        economicStrategy: ['Aggressive', 'Balanced', 'Defensive'][Math.floor(Math.random() * 3)],
                        marketInfluence: Math.random() * 0.3
                    });
                }
            }
            
            // Adjust difficulty
            if (economyDifficulty === 'easy') {
                gameData.money = gameMode === "sandbox" ? 999999 : 15000;
                gameData.marketDemand = { weed: 80, meth: 50, coke: 35, heroin: 20, fentanyl: 10 };
                gameData.personnel = { producers: 3, dealers: 4, soldiers: gameMode === "creative" ? 10 : 3, spies: 0, accountants: 1 };
            } else if (economyDifficulty === 'hard') {
                gameData.money = gameMode === "sandbox" ? 999999 : 7500;
                gameData.marketDemand = { weed: 60, meth: 30, coke: 15, heroin: 10, fentanyl: 3 };
                gameData.priceVolatility = { weed: 0.15, meth: 0.2, coke: 0.25, heroin: 0.3, fentanyl: 0.35 };
                gameData.economicStability = 60;
            } else if (economyDifficulty === 'realistic') {
                gameData.money = gameMode === "sandbox" ? 999999 : 5000;
                gameData.marketDemand = { weed: 50, meth: 25, coke: 12, heroin: 8, fentanyl: 2 };
                gameData.priceVolatility = { weed: 0.2, meth: 0.25, coke: 0.3, heroin: 0.35, fentanyl: 0.4 };
                gameData.economicStability = 50;
                gameData.inflation = 0.05;
            }
            
            // Sandbox mode adjustments
            if (gameMode === "sandbox") {
                gameData.personnel = { producers: 10, dealers: 10, soldiers: 10, spies: 5, accountants: 5 };
                gameData.labLevel = 3;
                gameData.inventory = { weed: 100, meth: 100, coke: 100, heroin: 100, fentanyl: 100, chemicals: 1000 };
            }
        }

        function gameLoop() {
            if (isPaused || gameData.gameOver) return;
            
            updateMarketConditions();
            runProduction();
            runDistribution();
            runLaundering();
            runPersonnelSystem();
            runEmpireManagement();
            
            if (gameMode !== "creative") {
                runAiTurns();
            }
            
            updateResearch();
            updateManualProduction();
            updateEconomicEvents();
            updateBankingSystem();
            updateStockMarket();
            updateEquipment();
            checkVictoryConditions();
            
            updateUI();
        }

        function updateMarketConditions() {
            const drugs = ['weed', 'meth', 'coke', 'heroin', 'fentanyl'];
            
            drugs.forEach(drug => {
                let totalSupply = gameData.inventory[drug];
                
                if (gameMode !== "creative") {
                    gameData.aiPlayers.forEach(ai => {
                        totalSupply += Math.random() * 20;
                    });
                }
                
                const baseDemand = gameData.marketDemand[drug];
                const volatility = gameData.priceVolatility[drug];
                
                let demandChange = 0;
                if (Math.random() < 0.2) {
                    demandChange = (Math.random() - 0.5) * 20;
                    gameData.marketDemand[drug] = Math.max(10, Math.min(100, baseDemand + demandChange));
                }
                
                const supplyDemandRatio = totalSupply / (baseDemand * 10);
                const priceChange = (1 - supplyDemandRatio) * volatility * gameData.marketPrices[drug];
                
                gameData.marketPrices[drug] = Math.max(
                    gameData.marketPrices[drug] * 0.5,
                    Math.min(
                        gameData.marketPrices[drug] * 1.5,
                        gameData.marketPrices[drug] + priceChange
                    )
                );
                
                if (gameData.economicCycles.boom) {
                    gameData.marketPrices[drug] *= 1.1;
                } else if (gameData.economicCycles.recession) {
                    gameData.marketPrices[drug] *= 0.9;
                }
                
                gameData.marketPrices[drug] *= (1 + gameData.inflation);
            });
            
            if (gameData.economicCycles.duration > 0) {
                gameData.economicCycles.duration--;
            } else {
                if (Math.random() < 0.1) {
                    gameData.economicCycles.boom = true;
                    gameData.economicCycles.recession = false;
                    gameData.economicCycles.duration = 10 + Math.floor(Math.random() * 20);
                    gameData.economicEvents.push({
                        type: 'boom',
                        message: 'Economic boom! Market prices are rising.',
                        duration: gameData.economicCycles.duration
                    });
                } else if (Math.random() < 0.1) {
                    gameData.economicCycles.boom = false;
                    gameData.economicCycles.recession = true;
                    gameData.economicCycles.duration = 10 + Math.floor(Math.random() * 20);
                    gameData.economicEvents.push({
                        type: 'recession',
                        message: 'Economic recession! Market prices are falling.',
                        duration: gameData.economicCycles.duration
                    });
                } else {
                    gameData.economicCycles.boom = false;
                    gameData.economicCycles.recession = false;
                }
            }
            
            if (Math.random() < 0.05) {
                gameData.inflation += (Math.random() - 0.5) * 0.02;
                gameData.inflation = Math.max(0, Math.min(0.2, gameData.inflation));
            }
            
            gameData.resourcePrices.chemicals *= (1 + (Math.random() - 0.4) * 0.1);
            gameData.resourcePrices.equipment *= (1 + (Math.random() - 0.3) * 0.08);
            gameData.resourcePrices.vehicles *= (1 + (Math.random() - 0.2) * 0.05);
        }

        function runProduction() {
            const productionRate = gameData.personnel.producers * 0.2 * (gameData.labLevel + 1) * (gameData.equipment.labs.condition / 100);
            
            gameData.inventory[gameData.currentDrug] += Math.floor(productionRate);
            
            if (gameData.currentDrug !== 'weed') {
                const chemicalCost = productionRate * 0.5;
                gameData.inventory.chemicals = Math.max(0, gameData.inventory.chemicals - chemicalCost);
            }
            
            gameData.heat += productionRate * 0.03 * (gameData.labLevel + 1);
            
            gameData.equipment.labs.condition = Math.max(0, gameData.equipment.labs.condition - 0.1);
        }

        function runDistribution() {
            const distributionCapacity = gameData.personnel.dealers * 0.5 * gameData.distributionNetworks * 
                                       gameData.transportation.efficiency * (gameData.equipment.vehicles.condition / 100);
            
            const drugs = ['weed', 'meth', 'coke', 'heroin', 'fentanyl'];
            
            drugs.forEach(drug => {
                if (gameData.inventory[drug] > 0) {
                    const marketShare = Math.min(1, gameData.marketDemand[drug] / 100);
                    const potentialSales = distributionCapacity * marketShare;
                    const actualSales = Math.min(gameData.inventory[drug], potentialSales);
                    
                    const revenue = actualSales * gameData.marketPrices[drug];
                    
                    const remainingCap = gameData.drugEarningCaps[drug] - gameData.drugEarnings[drug];
                    
                    if (remainingCap > 0) {
                        const actualRevenue = Math.min(revenue, remainingCap);
                        const actualSold = Math.floor(actualRevenue / gameData.marketPrices[drug]);
                        
                        gameData.inventory[drug] -= actualSold;
                        gameData.money += actualRevenue;
                        gameData.drugEarnings[drug] += actualRevenue;
                        gameData.heat += actualSold * 0.05;
                        
                        if (actualRevenue < revenue) {
                            showNotification(`Market saturated! ${drug.toUpperCase()} earnings capped at $${gameData.drugEarningCaps[drug]}`, "orange");
                        }
                    }
                }
            });
            
            gameData.equipment.vehicles.condition = Math.max(0, gameData.equipment.vehicles.condition - 0.05);
        }

        function runLaundering() {
            let launderingCap = gameData.properties.reduce((sum, p) => sum + p.cleanRate, 0);
            launderingCap += gameData.personnel.accountants * 500;
            
            if (gameData.research.laundering1.unlocked) launderingCap *= 1.2;
            if (gameData.research.laundering2.unlocked) launderingCap *= 1.25;
            
            const efficiency = gameData.economicStability / 100;
            
            let amountToLaunder = Math.min(gameData.money, launderingCap * efficiency);
            if (amountToLaunder > 0) {
                gameData.money -= amountToLaunder;
                gameData.whiteMoney += amountToLaunder * 0.7;
                gameData.heat -= amountToLaunder * 0.0001;
            }
        }

        function updateBankingSystem() {
            if (Math.random() < gameData.bankAccounts.local.seizureRisk) {
                const seizedAmount = gameData.bankAccounts.local.balance * 0.2;
                gameData.bankAccounts.local.balance -= seizedAmount;
                showNotification(`Police seized $${seizedAmount.toFixed(0)} from your local bank account!`, "red");
            }
            
            if (Math.random() < gameData.bankAccounts.offshore.seizureRisk) {
                const seizedAmount = gameData.bankAccounts.offshore.balance * 0.1;
                gameData.bankAccounts.offshore.balance -= seizedAmount;
                showNotification(`International authorities seized $${seizedAmount.toFixed(0)} from your offshore account!`, "red");
            }
            
            gameData.loans.forEach(loan => {
                if (loan.remainingPayments > 0) {
                    const payment = loan.monthlyPayment;
                    if (gameData.whiteMoney >= payment) {
                        gameData.whiteMoney -= payment;
                        loan.remainingPayments--;
                        loan.remainingAmount -= payment;
                    } else {
                        gameData.reputation -= 10;
                        gameData.economicStability -= 5;
                        showNotification(`Defaulted on loan from ${loan.source}! Reputation decreased.`, "red");
                        gameData.loans = gameData.loans.filter(l => l.id !== loan.id);
                    }
                } else {
                    gameData.loans = gameData.loans.filter(l => l.id !== loan.id);
                }
            });
        }

        function updateStockMarket() {
            for (const [company, data] of Object.entries(gameData.stocks)) {
                const change = (Math.random() - 0.5) * 2 * data.volatility;
                data.price = Math.max(10, data.price * (1 + change));
                
                if (gameData.economicCycles.boom) {
                    data.price *= 1.05;
                } else if (gameData.economicCycles.recession) {
                    data.price *= 0.95;
                }
            }
            
            let totalDividends = 0;
            for (const [company, data] of Object.entries(gameData.stocks)) {
                if (data.owned > 0) {
                    const dividend = data.owned * data.price * 0.01;
                    totalDividends += dividend;
                }
            }
            
            if (totalDividends > 0) {
                gameData.whiteMoney += totalDividends;
            }
        }

        function updateEquipment() {
            if (gameData.equipment.labs.condition < 20) {
                showNotification("Your lab equipment is in poor condition and needs maintenance!", "orange");
            }
            
            if (gameData.equipment.vehicles.condition < 20) {
                showNotification("Your vehicles are in poor condition and need maintenance!", "orange");
            }
            
            if (gameData.equipment.weapons.condition < 20) {
                showNotification("Your weapons are in poor condition and need maintenance!", "orange");
            }
        }

        function updateEconomicEvents() {
            if (Math.random() < 0.05) {
                const events = [
                    {
                        type: "police",
                        message: "Police crackdown on drug trade! Market demand decreased.",
                        effect: () => {
                            for (const drug in gameData.marketDemand) {
                                gameData.marketDemand[drug] = Math.max(10, gameData.marketDemand[drug] - 15);
                            }
                        }
                    },
                    {
                        type: "new_drug",
                        message: "New synthetic drug trend! Market demand for fentanyl increased.",
                        effect: () => {
                            gameData.marketDemand.fentanyl += 20;
                        }
                    },
                    {
                        type: "supply_shortage",
                        message: "Chemical supply shortage! Chemical prices increased.",
                        effect: () => {
                            gameData.resourcePrices.chemicals *= 1.5;
                        }
                    },
                    {
                        type: "tax_audit",
                        message: "Tax audit on your legitimate businesses! Laundering efficiency decreased.",
                        effect: () => {
                            gameData.economicStability -= 10;
                        }
                    }
                ];
                
                const event = events[Math.floor(Math.random() * events.length)];
                event.effect();
                showNotification(event.message, "orange");
            }
            
            gameData.economicEvents = gameData.economicEvents.filter(event => event.duration > 0);
            gameData.economicEvents.forEach(event => event.duration--);
        }

        function runAiTurns() {
            gameData.aiPlayers.forEach(ai => {
                ai.money += 100 * ai.powerLevel;
                if (Math.random() > 0.97) { 
                    const weakTerritories = gameData.territories.filter(t => t.owner !== ai.id && t.soldiers < (ai.powerLevel * 2));
                    if (weakTerritories.length > 0) {
                        const target = weakTerritories[Math.floor(Math.random() * weakTerritories.length)];
                        target.owner = ai.id;
                        target.soldiers = ai.powerLevel;
                        showNotification(`${ai.name} has taken control of ${target.name}!`, "orange");
                    }
                }
            });
        }

        function checkVictoryConditions() {
            if (gameData.gameOver) return;
            
            gameData.victory.domination.current = gameData.territories.filter(t => t.owner === 'Player').length;
            if (gameData.victory.domination.current >= gameData.victory.domination.required) {
                triggerGameOver("VICTORY! You control the city.");
                return;
            }
            
            gameData.victory.economic.current = gameData.whiteMoney;
            if (gameData.victory.economic.current >= gameData.victory.economic.required) {
                triggerGameOver("VICTORY! Your financial empire is untouchable.");
                return;
            }
            
            if (gameData.heat >= 200) {
                triggerGameOver("BUSTED! The heat was too much.");
                return;
            }
            
            if (gameData.money <= -10000) {
                triggerGameOver("BANKRUPT! Your empire has collapsed.");
                return;
            }
            
            if (gameData.personnelLoyalty <= 0) {
                triggerGameOver("BETRAYED! Your personnel have abandoned you.");
                return;
            }
            
            if (gameMode !== "creative") {
                let aiControlCount = 0;
                gameData.aiPlayers.forEach(ai => {
                    aiControlCount += gameData.territories.filter(t => t.owner === ai.id).length;
                });
                
                if (aiControlCount >= 12) {
                    triggerGameOver("DEFEATED! Rivals have taken over the city.");
                    return;
                }
            }
        }

        function triggerGameOver(message) {
            gameData.gameOver = true;
            if (turnTimer) {
                clearInterval(turnTimer);
                turnTimer = null;
            }
            document.getElementById('gameOverText').textContent = message;
            document.getElementById('gameOverScreen').style.display = 'flex';
        }

        // Player actions
        function hirePersonnel(type) {
            const costs = {
                producer: 500,
                dealer: 750,
                soldier: 1000,
                spy: 2500,
                accountant: 2000,
                lieutenant: 50000
            };
            
            const cost = costs[type];
            if (gameData.money >= cost) {
                gameData.money -= cost;
                if (type === 'lieutenant') {
                    const names = ["Rico", "Chico", "Lefty", "Sonny", "Benny", "Marco", "Vito", "Luca"];
                    gameData.lieutenants.push({
                        name: names[Math.floor(Math.random() * names.length)],
                        skill: ['logistics', 'combat', 'diplomacy'][Math.floor(Math.random() * 3)]
                    });
                } else {
                    gameData.personnel[type + 's']++;
                }
                showNotification(`Hired a new ${type}.`, "lightgreen");
            } else {
                showNotification(`Not enough money to hire a ${type}.`, "orange");
            }
        }

        function produceWeed() {
            if (gameData.manualProduction.weed.progress > 0) {
                showNotification("Already producing weed!", "orange");
                return;
            }
            
            gameData.manualProduction.weed.progress = gameData.manualProduction.weed.time;
            showNotification("Started manual weed production", "lightgreen");
        }

        function updateManualProduction() {
            if (gameData.manualProduction.weed.progress > 0) {
                gameData.manualProduction.weed.progress--;
                if (gameData.manualProduction.weed.progress === 0) {
                    gameData.inventory.weed += 5;
                    showNotification("Manual production complete: +5 Weed", "lightgreen");
                }
            }
        }

        function upgradeLab() {
            const costs = [25000, 100000, 500000, 2000000, 10000000];
            const drugs = ["weed", "meth", "coke", "heroin", "fentanyl"];
            
            if (gameData.labLevel >= costs.length) {
                showNotification("Lab is max level.", "lightblue");
                return;
            }
            
            let cost = costs[gameData.labLevel];
            if (gameData.money >= cost) {
                gameData.money -= cost;
                gameData.labLevel++;
                gameData.currentDrug = drugs[gameData.labLevel];
                showNotification(`Lab upgraded to produce ${gameData.currentDrug}!`, "lightgreen");
            } else {
                showNotification(`Need $${cost} to upgrade lab.`, "orange");
            }
        }

        function attackTerritory(territoryId) {
            const territory = gameData.territories[territoryId];
            if (territory.owner === 'Player') {
                showNotification("You already control this territory.", "orange");
                return;
            }
            
            if (gameData.personnel.soldiers < 1) {
                showNotification("You need soldiers to take territory!", "orange");
                return;
            }
            
            let attackPower = gameData.personnel.soldiers;
            let defensePower = territory.soldiers;
            
            if (attackPower > defensePower) {
                territory.owner = 'Player';
                territory.soldiers = Math.max(1, Math.floor(attackPower / 2));
                gameData.personnel.soldiers = Math.ceil(gameData.personnel.soldiers / 2);
                showNotification(`You captured ${territory.name}!`, "lightgreen");
            } else {
                gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - defensePower);
                showNotification("Your attack failed! You lost soldiers.", "red");
            }
        }

        function buyProperty(name, cost, cleanRate) {
            if (gameData.money < cost) {
                showNotification("Not enough dirty money!", "orange");
                return;
            }
            
            gameData.money -= cost;
            if (!gameData.properties) gameData.properties = [];
            gameData.properties.push({ name, cleanRate });
            showNotification(`${name} purchased!`, "lightgreen");
        }

        function takeLoan(amount, source) {
            const loan = {
                id: Date.now(),
                amount: amount,
                remainingAmount: amount * 1.2,
                monthlyPayment: (amount * 1.2) / 12,
                remainingPayments: 12,
                source: source
            };
            
            gameData.loans.push(loan);
            gameData.whiteMoney += amount;
            showNotification(`Taken a $${amount} loan from ${source}.`, "lightgreen");
        }

        function buyStock(company, amount) {
            const cost = gameData.stocks[company].price * amount;
            if (gameData.whiteMoney >= cost) {
                gameData.whiteMoney -= cost;
                gameData.stocks[company].owned += amount;
                showNotification(`Bought ${amount} shares of ${company}.`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to buy ${amount} shares of ${company}.`, "orange");
            }
        }

        function sellStock(company, amount) {
            if (gameData.stocks[company].owned >= amount) {
                const revenue = gameData.stocks[company].price * amount;
                gameData.whiteMoney += revenue;
                gameData.stocks[company].owned -= amount;
                showNotification(`Sold ${amount} shares of ${company} for $${revenue}.`, "lightgreen");
            } else {
                showNotification(`You don't own enough shares of ${company} to sell ${amount}.`, "orange");
            }
        }

        function depositMoney(account, amount) {
            if (gameData.whiteMoney >= amount) {
                gameData.whiteMoney -= amount;
                gameData.bankAccounts[account].balance += amount;
                showNotification(`Deposited $${amount} to your ${account} account.`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to deposit $${amount}.`, "orange");
            }
        }

        function withdrawMoney(account, amount) {
            if (gameData.bankAccounts[account].balance >= amount) {
                gameData.bankAccounts[account].balance -= amount;
                
                if (account === 'offshore') {
                    const fee = amount * gameData.bankAccounts.offshore.transferFee;
                    amount -= fee;
                    showNotification(`Transferred $${amount} from offshore account ($${fee} fee).`, "lightgreen");
                }
                
                gameData.whiteMoney += amount;
            } else {
                showNotification(`Not enough money in your ${account} account to withdraw $${amount}.`, "orange");
            }
        }

        function repairEquipment(type) {
            const cost = gameData.resourcePrices.equipment * 10;
            if (gameData.money >= cost) {
                gameData.money -= cost;
                gameData.equipment[type].condition = 100;
                showNotification(`Repaired all ${type} equipment.`, "lightgreen");
            } else {
                showNotification(`Not enough money to repair ${type} equipment.`, "orange");
            }
        }

        function buyResources(type, amount) {
            const cost = gameData.resourcePrices[type] * amount;
            if (gameData.money >= cost) {
                gameData.money -= cost;
                gameData.inventory[type] += amount;
                showNotification(`Bought ${amount} units of ${type}.`, "lightgreen");
            } else {
                showNotification(`Not enough money to buy ${amount} units of ${type}.`, "orange");
            }
        }

        function startResearch(researchId) {
            if (gameData.researchInProgress) {
                showNotification("Research already in progress.", "orange");
                return;
            }
            
            const r = gameData.research[researchId];
            if (gameData.whiteMoney < r.cost) {
                showNotification(`Need $${r.cost} in clean money for research.`, "orange");
                return;
            }
            
            const requirementMet = r.requires ? gameData.research[r.requires].unlocked : true;
            if (!requirementMet) {
                showNotification("Previous technology not researched yet.", "orange");
                return;
            }
            
            gameData.whiteMoney -= r.cost;
            gameData.researchInProgress = researchId;
            showNotification(`Research started on ${r.name}.`, "lightblue");
        }

        function updateResearch() {
            if (gameData.researchInProgress) {
                const r = gameData.research[gameData.researchInProgress];
                r.progress += 2;
                if (r.progress >= r.time) {
                    r.unlocked = true;
                    r.progress = r.time;
                    showNotification(`Research complete: ${r.name}!`, "lightgreen");
                    gameData.researchInProgress = null;
                }
            }
        }

        function runPersonnelSystem() {
            const totalPersonnel = gameData.personnel.producers + gameData.personnel.dealers +
                                 gameData.personnel.soldiers + gameData.personnel.spies +
                                 gameData.personnel.accountants;
            
            const wages = totalPersonnel * 50;
            if (gameData.money >= wages) {
                gameData.money -= wages;
                if (gameData.personnelLoyalty < 100) gameData.personnelLoyalty += 1;
            } else {
                gameData.personnelLoyalty = Math.max(0, gameData.personnelLoyalty - 5);
                showNotification("Can't afford payroll! Morale is dropping!", "red");
            }
        }

        function runEmpireManagement() {
            let territoryIncome = gameData.territories.reduce((sum, t) => {
                return t.owner === 'Player' ? sum + (t.value * 10) : sum;
            }, 0);
            
            gameData.money += territoryIncome;
        }

        function showTab(tabName) {
            currentActiveTab = tabName;
            updateUI();
        }

        function handleButtonClick(actionFn, ...args) {
            if (isPaused) {
                showNotification("Game is paused!", "orange");
                return;
            }
            actionFn(...args);
            updateUI();
        }

        function showNotification(msg, color = "#0f0") {
            const n = document.createElement("div");
            n.textContent = msg;
            n.style.color = "black";
            n.style.background = color;
            n.style.padding = "5px 10px";
            n.style.borderRadius = "5px";
            n.style.marginTop = "5px";
            document.getElementById('notifications').appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }

        function togglePause() {
            if (gameData.gameOver) return;
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            const pauseOverlay = document.getElementById('pauseOverlay');
            if (isPaused) {
                if (turnTimer) {
                    clearInterval(turnTimer);
                    turnTimer = null;
                }
                if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') ytPlayer.pauseVideo();
                pauseBtn.textContent = "Resume";
                pauseOverlay.style.display = 'flex';
            } else {
                startTurnTimer();
                if (ytPlayer && typeof ytPlayer.playVideo === 'function') ytPlayer.playVideo();
                pauseBtn.textContent = "Pause";
                pauseOverlay.style.display = 'none';
            }
        }

        function updateUI() {
            if (!gameData || !gameData.territories || gameData.gameOver) return;

            // Top stats bar
            document.getElementById('top-stats').innerHTML = `
                <p>💰 $${Math.floor(gameData.money)}</p>
                <p>💵 $${Math.floor(gameData.whiteMoney)}</p>
                <p>🔥 ${Math.floor(gameData.heat)}</p>
                <p>📈 ${(gameData.inflation * 100).toFixed(1)}%</p>
            `;

            // Operations panel
            const weedProgressPercent = (gameData.manualProduction.weed.progress / gameData.manualProduction.weed.time) * 100;
            document.getElementById('operations').innerHTML = `
                <h2>Operations</h2>
                <div class="item-list">
                    <h3>Drug Operation</h3>
                    <p>Producing: ${gameData.currentDrug.toUpperCase()}</p>
                    <p>Earnings: $${gameData.drugEarnings[gameData.currentDrug]}/$${gameData.drugEarningCaps[gameData.currentDrug]}</p>
                    <button onclick="handleButtonClick(upgradeLab)">
                        Upgrade Lab (Lvl ${gameData.labLevel})
                    </button>
                    
                    <h3>Manual Production</h3>
                    <p>Weed: ${Math.floor(gameData.inventory.weed)} units</p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${100 - weedProgressPercent}%;"></div>
                    </div>
                    <button onclick="handleButtonClick(produceWeed)" ${gameData.manualProduction.weed.progress > 0 ? 'disabled' : ''}>
                        ${gameData.manualProduction.weed.progress > 0 ? 'Producing...' : 'Produce Weed (5 units)'}
                    </button>

                    <h3>Resource Management</h3>
                    <p>Chemicals: ${Math.floor(gameData.inventory.chemicals)} units</p>
                    <button onclick="handleButtonClick(buyResources, 'chemicals', 10)">Buy Chemicals (10 for $${Math.floor(gameData.resourcePrices.chemicals * 10)})</button>
                    
                    <h3>Equipment Status</h3>
                    <p>Labs: ${gameData.equipment.labs.condition.toFixed(0)}%</p>
                    <p>Vehicles: ${gameData.equipment.vehicles.condition.toFixed(0)}%</p>
                    <p>Weapons: ${gameData.equipment.weapons.condition.toFixed(0)}%</p>
                    <button onclick="handleButtonClick(repairEquipment, 'labs')">Repair Labs ($${Math.floor(gameData.resourcePrices.equipment * 10)})</button>
                    <button onclick="handleButtonClick(repairEquipment, 'vehicles')">Repair Vehicles ($${Math.floor(gameData.resourcePrices.equipment * 10)})</button>

                    <h3>Law Enforcement</h3>
                    <button onclick="handleButtonClick(fightBack)">Fight Back</button>
                </div>
            `;

            // Center panel with tabs
            document.getElementById('center-panel').innerHTML = `
                <div class="tab-buttons">
                    <button class="tab-link ${currentActiveTab === 'map-panel' ? 'active' : ''}" onclick="showTab('map-panel')">Map</button>
                    <button class="tab-link ${currentActiveTab === 'management-panel' ? 'active' : ''}" onclick="showTab('management-panel')">Management</button>
                    <button class="tab-link ${currentActiveTab === 'banking-panel' ? 'active' : ''}" onclick="showTab('banking-panel')">Banking</button>
                    <button class="tab-link ${currentActiveTab === 'market-panel' ? 'active' : ''}" onclick="showTab('market-panel')">Market</button>
                    <button class="tab-link ${currentActiveTab === 'research-panel' ? 'active' : ''}" onclick="showTab('research-panel')">Research</button>
                </div>
                <div id="map-panel" class="tab-content ${currentActiveTab === 'map-panel' ? 'active' : ''}"></div>
                <div id="management-panel" class="tab-content ${currentActiveTab === 'management-panel' ? 'active' : ''}"></div>
                <div id="banking-panel" class="tab-content ${currentActiveTab === 'banking-panel' ? 'active' : ''}"></div>
                <div id="market-panel" class="tab-content ${currentActiveTab === 'market-panel' ? 'active' : ''}"></div>
                <div id="research-panel" class="tab-content ${currentActiveTab === 'research-panel' ? 'active' : ''}"></div>
            `;

            // Map panel
            let mapHTML = `<h2>City Map</h2><p>Click a territory to attack.</p><div id="map-grid">`;
            const ownerColors = { 'Player': 'player', 'AI-1': 'ai-1', 'AI-2': 'ai-2', 'AI-3': 'ai-3', 'Neutral': 'neutral' };
            gameData.territories.forEach(t => {
                mapHTML += `
                    <div class="territory ${ownerColors[t.owner] || 'neutral'}-controlled"
                         onclick="handleButtonClick(attackTerritory, ${t.id})">
                         <span>${t.name}</span>
                         <span>${t.owner}</span>
                         <span>⚔️ ${t.soldiers}</span>
                    </div>`;
            });
            mapHTML += `</div>`;
            document.getElementById('map-panel').innerHTML = mapHTML;

            // Management panel
            document.getElementById('management-panel').innerHTML = `
                <h2>Gang Management</h2>
                <div class="item-list">
                    <h3>Personnel</h3>
                    <p>Producers: ${gameData.personnel.producers}</p>
                    <button onclick="handleButtonClick(hirePersonnel, 'producer')">Hire Producer ($500)</button>
                    
                    <p>Dealers: ${gameData.personnel.dealers}</p>
                    <button onclick="handleButtonClick(hirePersonnel, 'dealer')">Hire Dealer ($750)</button>
                    
                    <p>Soldiers: ${gameData.personnel.soldiers}</p>
                    <button onclick="handleButtonClick(hirePersonnel, 'soldier')">Hire Soldier ($1000)</button>
                    
                    <p>Spies: ${gameData.personnel.spies}</p>
                    <button onclick="handleButtonClick(hirePersonnel, 'spy')">Hire Spy ($2500)</button>
                    
                    <p>Accountants: ${gameData.personnel.accountants}</p>
                    <button onclick="handleButtonClick(hirePersonnel, 'accountant')">Hire Accountant ($2000)</button>
                    
                    <h3>Lieutenants</h3>
                    ${gameData.lieutenants.length > 0 ? gameData.lieutenants.map((lt, i) => `
                        <div class="list-item">
                            <strong>${lt.name}</strong> - ${lt.skill}
                        </div>
                    `).join('') : '<p>No lieutenants hired</p>'}
                    <button onclick="handleButtonClick(hirePersonnel, 'lieutenant')">Hire Lieutenant ($50,000)</button>
                </div>
            `;

            // Banking panel
            document.getElementById('banking-panel').innerHTML = `
                <h2>Banking System</h2>
                <div class="item-list">
                    <h3>Banking Overview</h3>
                    <div class="indicator">
                        <span class="indicator-label">Money Laundering Efficiency</span>
                        <div class="indicator-bar">
                            <div class="indicator-fill" style="width: ${gameData.economicStability}%; background: ${gameData.economicStability > 70 ? '#0f0' : gameData.economicStability > 40 ? '#ff0' : '#f00'}"></div>
                        </div>
                        <span class="indicator-value">${Math.floor(gameData.economicStability)}%</span>
                    </div>
                    
                    <p>Total Clean Money: $${Math.floor(gameData.whiteMoney)}</p>
                    <p>Total Dirty Money: $${Math.floor(gameData.money)}</p>
                    
                    <h3>Quick Actions</h3>
                    <button onclick="handleButtonClick(launderMoney, 1000)">Launder $1000</button>
                    <button onclick="handleButtonClick(launderMoney, 5000)">Launder $5000</button>
                    <button onclick="handleButtonClick(launderMoney, 10000)">Launder $10000</button>
                    
                    <h3>Money Laundering Options</h3>
                    <div class="list-item">
                        <strong>Small Businesses</strong>
                        <p>Efficiency: 65% | Risk: Low</p>
                        <button onclick="handleButtonClick(establishBusiness, 'small')">Establish ($10,000)</button>
                    </div>
                    <div class="list-item">
                        <strong>Restaurants</strong>
                        <p>Efficiency: 75% | Risk: Medium</p>
                        <button onclick="handleButtonClick(establishBusiness, 'restaurant')">Establish ($25,000)</button>
                    </div>
                    <div class="list-item">
                        <strong>Nightclubs</strong>
                        <p>Efficiency: 85% | Risk: High</p>
                        <button onclick="handleButtonClick(establishBusiness, 'nightclub')">Establish ($50,000)</button>
                    </div>
                    <div class="list-item">
                        <strong>Real Estate</strong>
                        <p>Efficiency: 90% | Risk: Very High</p>
                        <button onclick="handleButtonClick(establishBusiness, 'realestate')">Establish ($100,000)</button>
                    </div>
                    
                    <h3>Financial Operations</h3>
                    <button onclick="handleButtonClick(loanSharking, 5000)">Loan Sharking Operation ($5,000 setup)</button>
                    <button onclick="handleButtonClick(investStockMarket, 10000)">Stock Market Investment ($10,000)</button>
                    <button onclick="handleButtonClick(offshoreTransfer, 5000)">Offshore Transfer ($5,000)</button>
                    
                    <h3>Banking Upgrades</h3>
                    <div class="list-item">
                        <strong>Better Accountants</strong>
                        <p>+10% laundering efficiency</p>
                        <button onclick="handleButtonClick(upgradeBanking, 'accountants')">Upgrade ($15,000)</button>
                    </div>
                    <div class="list-item">
                        <strong>Shell Companies</strong>
                        <p>+15% laundering efficiency</p>
                        <button onclick="handleButtonClick(upgradeBanking, 'shell')">Upgrade ($30,000)</button>
                    </div>
                    <div class="list-item">
                        <strong>Offshore Banking</strong>
                        <p>+20% laundering efficiency</p>
                        <button onclick="handleButtonClick(upgradeBanking, 'offshore')">Upgrade ($50,000)</button>
                    </div>
                    
                    <h3>Risk Management</h3>
                    <p>Current Heat Level: ${Math.floor(gameData.heat)}/200</p>
                    <p>Seizure Risk: ${(calculateSeizureRisk() * 100).toFixed(1)}%</p>
                    <button onclick="handleButtonClick(bribeOfficials, 2000)">Bribe Officials ($2,000)</button>
                    <button onclick="handleButtonClick(hireLawyer, 5000)">Hire Lawyer ($5,000)</button>
                    <button onclick="handleButtonClick(launderSlow, 1000)">Slow Laundering (-50% heat)</button>
                </div>
            `;

            // Market panel
            let marketHTML = `
                <h2>Market Conditions</h2>
                <div class="item-list">
                    <h3>Drug Markets</h3>
                    <div class="market-card">
                        ${Object.entries(gameData.marketPrices).map(([drug, price]) => `
                            <div class="resource-row">
                                <span class="resource-name">${drug.charAt(0).toUpperCase() + drug.slice(1)}</span>
                                <span class="resource-price">$${Math.floor(price)}</span>
                                <span class="resource-trend">${gameData.marketDemand[drug]}%</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h3>Resource Prices</h3>
                    <div class="market-card">
                        <div class="resource-row">
                            <span class="resource-name">Chemicals</span>
                            <span class="resource-price">$${Math.floor(gameData.resourcePrices.chemicals)}</span>
                        </div>
                        <div class="resource-row">
                            <span class="resource-name">Equipment</span>
                            <span class="resource-price">$${Math.floor(gameData.resourcePrices.equipment)}</span>
                        </div>
                        <div class="resource-row">
                            <span class="resource-name">Vehicles</span>
                            <span class="resource-price">$${Math.floor(gameData.resourcePrices.vehicles)}</span>
                        </div>
                    </div>
                    
                    <h3>Economic Indicators</h3>
                    <div class="indicator">
                        <span class="indicator-label">Stability</span>
                        <div class="indicator-bar">
                            <div class="indicator-fill" style="width: ${gameData.economicStability}%; background: ${gameData.economicStability > 70 ? '#0f0' : gameData.economicStability > 40 ? '#ff0' : '#f00'}"></div>
                        </div>
                        <span class="indicator-value">${Math.floor(gameData.economicStability)}%</span>
                    </div>
                    
                    <div class="indicator">
                        <span class="indicator-label">Inflation</span>
                        <div class="indicator-bar">
                            <div class="indicator-fill" style="width: ${gameData.inflation * 500}%; background: ${gameData.inflation < 0.05 ? '#0f0' : gameData.inflation < 0.1 ? '#ff0' : '#f00'}"></div>
                        </div>
                        <span class="indicator-value">${(gameData.inflation * 100).toFixed(1)}%</span>
                    </div>
                    
                    <h3>Economic Events</h3>
                    ${gameData.economicEvents.length > 0 ? gameData.economicEvents.map(event => `
                        <div class="list-item">
                            <p>${event.message} (${event.duration} turns left)</p>
                        </div>
                    `).join('') : '<p>No current economic events</p>'}
                </div>
            `;
            document.getElementById('market-panel').innerHTML = marketHTML;

            // Research panel
            let researchHTML = `<h2>Research & Development</h2>`;
            if (gameData.researchInProgress) {
                const r = gameData.research[gameData.researchInProgress];
                researchHTML += `<p>Research in Progress: ${r.name} (${Math.floor((r.progress / r.time) * 100)}%)</p>`;
            }
            researchHTML += `<div class="item-list">`;
            for (const [key, research] of Object.entries(gameData.research)) {
                const canResearch = !research.unlocked && !gameData.researchInProgress && 
                                   (!research.requires || gameData.research[research.requires].unlocked);
                researchHTML += `
                    <div class="list-item">
                        <strong>${research.name}</strong>
                        <p>${research.desc}</p>
                        <p>Cost: $${research.cost} clean money</p>
                        <p>Time: ${research.time} seconds</p>
                        <button onclick="handleButtonClick(startResearch, '${key}')" 
                                ${canResearch ? '' : 'disabled'}>
                                ${research.unlocked ? 'Researched' : canResearch ? 'Research' : 'Locked'}
                        </button>
                    </div>
                `;
            }
            researchHTML += `</div>`;
            document.getElementById('research-panel').innerHTML = researchHTML;

            // Personnel panel
            let loyaltyColor = gameData.personnelLoyalty > 60 ? 'lightgreen' : gameData.personnelLoyalty > 30 ? 'orange' : 'red';
            document.getElementById('personnel-inventory').innerHTML = `
                <h2>Empire Stats</h2>
                <div class="item-list">
                    <h3>Personnel</h3>
                    <p><strong>Morale: <span style="color:${loyaltyColor};">${gameData.personnelLoyalty.toFixed(1)}%</span></strong></p>
                    <p>Producers: ${gameData.personnel.producers}</p>
                    <p>Dealers: ${gameData.personnel.dealers}</p>
                    <p>Soldiers: ${gameData.personnel.soldiers}</p>
                    <p>Spies: ${gameData.personnel.spies}</p>
                    <p>Accountants: ${gameData.personnel.accountants}</p>
                    <hr/>
                    <h3>Victory Progress</h3>
                    <p>Domination: ${gameData.victory.domination.current}/${gameData.victory.domination.required} Territories</p>
                    <p>Economic: $${Math.floor(gameData.victory.economic.current)}/$${gameData.victory.economic.required}</p>
                    <hr/>
                    <h3>Drug Earnings</h3>
                    <p>Weed: $${gameData.drugEarnings.weed}/$${gameData.drugEarningCaps.weed}</p>
                    <p>Meth: $${gameData.drugEarnings.meth}/$${gameData.drugEarningCaps.meth}</p>
                    <p>Coke: $${gameData.drugEarnings.coke}/$${gameData.drugEarningCaps.coke}</p>
                    <p>Heroin: $${gameData.drugEarnings.heroin}/$${gameData.drugEarningCaps.heroin}</p>
                    <p>Fentanyl: $${gameData.drugEarnings.fentanyl}/$${gameData.drugEarningCaps.fentanyl}</p>
                </div>
            `;
        }

        // Helper functions for banking
        function calculateSeizureRisk() {
            return Math.min(0.5, gameData.heat / 400 + gameData.bankAccounts.local.seizureRisk);
        }

        function launderMoney(amount) {
            if (gameData.money >= amount) {
                gameData.money -= amount;
                gameData.whiteMoney += amount * 0.7;
                gameData.heat -= amount * 0.0001;
                showNotification(`Laundered $${amount}`, "lightgreen");
            } else {
                showNotification(`Not enough money to launder $${amount}`, "orange");
            }
        }

        function establishBusiness(type) {
            const costs = {
                'small': 10000,
                'restaurant': 25000,
                'nightclub': 50000,
                'realestate': 100000
            };
            
            const cleanRates = {
                'small': 500,
                'restaurant': 1250,
                'nightclub': 2500,
                'realestate': 5000
            };
            
            const cost = costs[type];
            if (gameData.whiteMoney >= cost) {
                gameData.whiteMoney -= cost;
                if (!gameData.properties) gameData.properties = [];
                gameData.properties.push({ 
                    name: type.charAt(0).toUpperCase() + type.slice(1) + " Business", 
                    cleanRate: cleanRates[type] 
                });
                showNotification(`Established ${type} business`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to establish ${type} business`, "orange");
            }
        }

        function loanSharking(amount) {
            if (gameData.whiteMoney >= amount) {
                gameData.whiteMoney -= amount;
                gameData.money += amount * 1.5;
                showNotification(`Started loan sharking operation`, "lightgreen");
            } else {
                showNotification(`Not enough clean money for loan sharking operation`, "orange");
            }
        }

        function investStockMarket(amount) {
            if (gameData.whiteMoney >= amount) {
                gameData.whiteMoney -= amount;
                // Random stock selection
                const stocks = Object.keys(gameData.stocks);
                const randomStock = stocks[Math.floor(Math.random() * stocks.length)];
                gameData.stocks[randomStock].owned += Math.floor(amount / gameData.stocks[randomStock].price);
                showNotification(`Invested $${amount} in stock market`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to invest $${amount}`, "orange");
            }
        }

        function offshoreTransfer(amount) {
            if (gameData.whiteMoney >= amount) {
                gameData.whiteMoney -= amount;
                gameData.bankAccounts.offshore.balance += amount;
                showNotification(`Transferred $${amount} to offshore account`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to transfer $${amount}`, "orange");
            }
        }

        function upgradeBanking(type) {
            const costs = {
                'accountants': 15000,
                'shell': 30000,
                'offshore': 50000
            };
            
            const cost = costs[type];
            if (gameData.whiteMoney >= cost) {
                gameData.whiteMoney -= cost;
                gameData.economicStability += 10;
                showNotification(`Upgraded banking system (${type})`, "lightgreen");
            } else {
                showNotification(`Not enough clean money for banking upgrade`, "orange");
            }
        }

        function bribeOfficials(amount) {
            if (gameData.money >= amount) {
                gameData.money -= amount;
                gameData.heat -= 20;
                showNotification(`Bribed officials, heat reduced`, "lightgreen");
            } else {
                showNotification(`Not enough money to bribe officials`, "orange");
            }
        }

        function hireLawyer(amount) {
            if (gameData.whiteMoney >= amount) {
                gameData.whiteMoney -= amount;
                gameData.bankAccounts.local.seizureRisk *= 0.7;
                gameData.bankAccounts.offshore.seizureRisk *= 0.7;
                showNotification(`Hired lawyer, seizure risk reduced`, "lightgreen");
            } else {
                showNotification(`Not enough clean money to hire lawyer`, "orange");
            }
        }

        function launderSlow(amount) {
            if (gameData.money >= amount) {
                gameData.money -= amount;
                gameData.whiteMoney += amount * 0.8;
                gameData.heat -= amount * 0.0002;
                showNotification(`Slow laundering completed, less heat generated`, "lightgreen");
            } else {
                showNotification(`Not enough money for slow laundering`, "orange");
            }
        }

        function fightBack() {
            if (gameData.personnel.soldiers < 1) {
                showNotification("You have no soldiers to fight back with!", "orange");
                return;
            }
            
            showNotification("You're fighting back against the heat!");
            if (Math.random() > 0.5) {
                showNotification("You fought back successfully! Heat rose by 15.", "lightgreen");
                gameData.heat += 15;
            } else {
                showNotification("Fight failed. You lost money and a soldier!", "red");
                gameData.money = Math.max(0, gameData.money - 5000);
                gameData.personnel.soldiers = Math.max(0, gameData.personnel.soldiers - 1);
            }
        }

        // Make functions globally available
        window.handleButtonClick = handleButtonClick;
        window.showTab = showTab;
        window.togglePause = togglePause;
        window.takeLoan = takeLoan;
        window.buyStock = buyStock;
        window.sellStock = sellStock;
        window.depositMoney = depositMoney;
        window.withdrawMoney = withdrawMoney;
        window.repairEquipment = repairEquipment;
        window.buyResources = buyResources;
        window.startGame = startGame;
        window.showMenuSection = showMenuSection;
        window.loadGame = loadGame;
        window.deleteSave = deleteSave;
        window.saveGame = saveGame;
        window.returnToMenu = returnToMenu;
        window.hirePersonnel = hirePersonnel;
        window.produceWeed = produceWeed;
        window.upgradeLab = upgradeLab;
        window.attackTerritory = attackTerritory;
        window.buyProperty = buyProperty;
        window.startResearch = startResearch;
        window.endTurn = endTurn;
        window.nextSong = nextSong;
        window.prevSong = prevSong;

        // Initialize the game
        document.addEventListener('DOMContentLoaded', function() {
            setupUIScaling();
            initMusicPlayer();
            showMenuSection('game-type-section');
        });
    </script>
</body>
</html>

