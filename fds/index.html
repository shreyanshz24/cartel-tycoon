<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartel Tycoon: Grand Strategy</title>
    <style>
        :root { --main-green: #00ff00; --main-red: #ff0000; --dark-bg: #0a0a0a; --card-bg: rgba(0, 20, 0, 0.7); --border-color: #003300; --player-color: #0077ff; --ai1-color: #ff7700; --ai2-color: #ff00ff; --ai3-color: #ffff00; --neutral-color: #555; }
        body { font-family: 'Courier New', monospace; background: var(--dark-bg); color: var(--main-green); margin: 0; padding: 0; overflow: hidden; }
        .container { display: none; padding: 15px; max-width: 1600px; margin: 0 auto; text-align: left; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; margin-bottom: 10px; }
        .header h1 { font-size: 2rem; color: var(--main-red); text-shadow: 0 0 15px var(--main-red); margin: 0; }
        .top-stats-bar { display: flex; gap: 20px; background: var(--card-bg); padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        
        main { display: grid; grid-template-columns: 300px 1fr 300px; gap: 15px; height: calc(100vh - 100px); }
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 0 12px rgba(0, 255, 0, 0.4); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        h2 { border-bottom: 1px solid var(--main-green); padding-bottom: 4px; margin-top: 0; margin-bottom: 8px; font-size: 1.2rem; }
        p { font-size: 0.9rem; line-height: 1.5; margin: 4px 0; }
        button { width: 100%; padding: 8px 10px; margin: 4px 0; background: var(--main-red); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: all 0.2s ease; box-sizing: border-box; font-size: 0.9rem; }

        .tab-buttons { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 10px; }
        .tab-link { background: none; border-radius: 6px 6px 0 0; border: 1px solid transparent; border-bottom: none; color: var(--main-green); opacity: 0.6; margin: 0 2px; flex-grow: 1; }
        .tab-link.active { background: var(--card-bg); border-color: var(--border-color); opacity: 1; }
        .tab-content { display: none; flex-grow: 1; overflow-y: auto; }
        .tab-content.active { display: block; }
        
        .item-list { overflow-y: auto; height: 100%; }
        .list-item { border-top: 1px solid var(--border-color); padding: 8px 0; margin-top: 8px; }

        /* --- MAP STYLES --- */
        #map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; }
        .territory { height: 60px; border: 2px solid #333; display: flex; justify-content: center; align-items: center; text-align: center; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .territory:hover { transform: scale(1.05); border-color: #fff; }
        .player-controlled { background-color: var(--player-color); }
        .ai-1-controlled { background-color: var(--ai1-color); }
        .ai-2-controlled { background-color: var(--ai2-color); }
        .ai-3-controlled { background-color: var(--ai3-color); }
        .neutral { background-color: var(--neutral-color); }

        #menu { display: flex; /* ... */ }
        #pauseBtn { width: 100px; background-color: #ffae00; }
        #pauseOverlay { display: none; /* ... */ }
    </style>
</head>
<body>
    <audio id="bgMusic" src="spanish_guitar.mp3" loop></audio>
    <div id="menu">
        <h1>Cartel Tycoon</h1>
        <input type="text" id="playerName" placeholder="Enter Your Name" style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
        <div id="singlePlayerOptions">
            <label for="aiCount" style="font-size: 1.5rem; color: #0f0;">AI Opponents (1-3):</label>
            <input type="number" id="aiCount" value="2" min="1" max="3" style="background:#000;border:1px solid #0f0;color:#0f0;padding:10px;text-align:center;font-family:'Courier New', monospace;margin:10px;">
        </div>
        <button onclick="startGame('single')" style="width: 300px;">Single Player</button>
    </div>

    <div id="game" class="container">
        <header class="header">
            <h1>Cartel Tycoon</h1>
            <div class="top-stats-bar" id="top-stats"></div>
            <button id="pauseBtn" onclick="togglePause()">Pause</button>
        </header>
        <main>
            <div class="card" id="operations"></div>
            <div class="card" id="center-panel"></div>
            <div class="card" id="personnel"></div>
        </main>
    </div>
    
    <div id="notifications" style="position:fixed;top:20px;right:20px;width:300px;z-index:1001;font-weight:bold;text-align:right;"></div>
    <div id="gameOverScreen" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);color:#f00;font-size:3rem;justify-content:center;align-items:center;flex-direction:column;z-index:1000;"><h2 id="gameOverText"></h2><button onclick="location.reload()">Start Over</button></div>
    <div id="pauseOverlay" onclick="togglePause()">PAUSED</div>

<script>
// =================================================================================
// SECTION 1: CORE GAME SETUP & STATE
// =================================================================================
let playerName = "";
let gameData = {};
let gameLoopInterval = null;
let isPaused = false;
let gameMode = 'single';
let currentActiveTab = 'map-panel';

function resetGameData(aiCount = 2) {
    gameData = {
        money: 5000, whiteMoney: 0, heat: 0, drugs: 0, currentDrug: "weed", labLevel: 0, chemicals: 0,
        personnel: { producers: 0, dealers: 0, soldiers: 0 },
        personnelLoyalty: 70, payrollDue: 100,
        territories: [],
        aiPlayers: [],
        gameOver: false
    };

    // Initialize Map
    const territoryNames = ["Docks", "Warehouse District", "Downtown", "Suburbs", "Projects", "West Side", "East Side", "Market", "Old Town", "The Strip", "Airport", "Industrial Park", "Southside", "Northbridge", "Chinatown"];
    for (let i = 0; i < 15; i++) {
        gameData.territories.push({ id: i, name: territoryNames[i], owner: 'Neutral', value: Math.floor(Math.random() * 50) + 10 });
    }
    // Player and AI starting territory
    gameData.territories[0].owner = 'Player';
    const aiNames = ["El Jefe", "La Reina", "The Ghost"];
    for (let i = 0; i < aiCount; i++) {
        gameData.territories[i + 1].owner = `AI-${i+1}`;
        gameData.aiPlayers.push({ id: `AI-${i+1}`, name: aiNames[i], money: 3000, soldiers: 2, powerLevel: 1, relationship: 0 });
    }
}

// =================================================================================
// SECTION 2: GAME START, LOOP, & PAUSE
// =================================================================================

function startGame(mode) {
    playerName = document.getElementById('playerName').value || "Player";
    gameMode = mode;
    document.getElementById('menu').style.display = 'none';
    document.getElementById('bgMusic').play().catch(e => console.log("Audio autoplay blocked."));
    if (gameMode === 'single') {
        const aiCount = parseInt(document.getElementById('aiCount').value) || 2;
        document.getElementById('game').style.display = 'block';
        resetGameData(aiCount);
        isPaused = false;
        gameLoopInterval = setInterval(gameLoop, 1000);
        updateUI();
    }
}

function gameLoop() {
    if (isPaused || gameData.gameOver) return;
    if (gameData.heat >= 200) triggerGameOver("BUSTED! The heat was too much.");
    runProduction();
    runSales();
    runPersonnelSystem();
    runAiTurns();
    updateUI();
}

function togglePause() {
    if (gameData.gameOver) return;
    isPaused = !isPaused; 
    const pauseBtn = document.getElementById('pauseBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');
    if (isPaused) {
        clearInterval(gameLoopInterval);
        pauseBtn.textContent = "Resume";
        pauseOverlay.style.display = 'flex';
    } else {
        gameLoopInterval = setInterval(gameLoop, 1000);
        pauseBtn.textContent = "Pause";
        pauseOverlay.style.display = 'none';
    }
}

// =================================================================================
// SECTION 3: CORE GAMEPLAY LOOPS (Production, Sales, Personnel)
// =================================================================================
function handleButtonClick(actionFn, ...args) { if (isPaused) { showNotification("Game is paused!", "orange"); return; } actionFn(...args); if (gameMode === 'single') updateUI(); }

function runProduction() {
    const { producers } = gameData.personnel;
    if (producers <= 0) return;
    let loyaltyBonus = 0.8 + (gameData.personnelLoyalty / 100) * 0.7;
    let labBonus = 1 + (gameData.labLevel * 0.5);
    let gain = producers * labBonus * loyaltyBonus;
    
    if (gameData.currentDrug !== 'weed') {
        if (gameData.chemicals >= producers) {
            gameData.chemicals -= producers;
        } else {
            showNotification("Production halted, not enough chemicals!", "orange");
            return;
        }
    }
    gameData.drugs += gain;
}

function runSales() {
    const { dealers } = gameData.personnel;
    if (dealers <= 0 || gameData.drugs <= 0) return;
    
    const playerTerritories = gameData.territories.filter(t => t.owner === 'Player');
    const maxSales = Math.min(gameData.drugs, dealers * 5); // A dealer can sell up to 5 units per tick
    let totalIncome = 0;
    
    if (playerTerritories.length > 0) {
        const incomePerSale = { "weed": 10, "meth": 25, "coke": 60, "heroin": 150, "fentanyl": 400 }[gameData.currentDrug] || 10;
        totalIncome = maxSales * incomePerSale;
        gameData.drugs -= maxSales;
        gameData.money += totalIncome;
        gameData.heat += totalIncome * 0.001; // Passive heat from sales
    }
}

function runPersonnelSystem() {
    const { producers, dealers, soldiers } = gameData.personnel;
    if (producers + dealers + soldiers <= 0) return;
    gameData.payrollDue--;
    if (gameData.payrollDue <= 0) {
        let payrollCost = (producers * 20) + (dealers * 30) + (soldiers * 50);
        if (gameData.money >= payrollCost) {
            gameData.money -= payrollCost;
            gameData.personnelLoyalty += 5;
        } else {
            gameData.personnelLoyalty -= 20;
            showNotification("CAN'T PAY PAYROLL! Morale has plummeted!", "red");
        }
        gameData.payrollDue = 100;
    }
    gameData.personnelLoyalty -= 0.05;
    if (gameData.personnelLoyalty > 100) gameData.personnelLoyalty = 100;
    if (gameData.personnelLoyalty <= 0) {
        gameData.heat += 100;
        // Randomly lose one personnel
        if (soldiers > 0) gameData.personnel.soldiers--;
        else if (dealers > 0) gameData.personnel.dealers--;
        else if (producers > 0) gameData.personnel.producers--;
        gameData.personnelLoyalty = 20;
        showNotification("A crew member snitched and quit! MASSIVE heat increase!", "red");
    }
}

// =================================================================================
// SECTION 4: PLAYER ACTIONS
// =================================================================================
function hirePersonnel(type) {
    const costs = { producer: 200, dealer: 500, soldier: 1000 };
    if (gameData.money < costs[type]) {
        showNotification("Not enough cash to hire.", "red");
        return;
    }
    gameData.money -= costs[type];
    gameData.personnel[type + 's']++;
}

function upgradeLab() {
    const costs = [5000, 25000, 100000, 500000];
    const unlocks = ['meth', 'coke', 'heroin', 'fentanyl'];
    if (gameData.labLevel >= costs.length) {
        showNotification("Lab is max level.", "orange");
        return;
    }
    let cost = costs[gameData.labLevel];
    if (gameData.whiteMoney < cost) {
        showNotification(`Need $${cost} in CLEAN money to upgrade.`, "red");
        return;
    }
    gameData.whiteMoney -= cost;
    gameData.labLevel++;
    gameData.currentDrug = unlocks[gameData.labLevel - 1];
    showNotification(`Lab upgraded! You can now produce ${gameData.currentDrug}.`, "lightgreen");
}

function attackTerritory(territoryId) {
    const territory = gameData.territories[territoryId];
    if (territory.owner === 'Player') {
        showNotification("You already control this territory.", "orange");
        return;
    }

    let enemy = gameData.aiPlayers.find(ai => ai.id === territory.owner);
    let enemySoldiers = enemy ? enemy.soldiers : 0;
    
    let playerPower = gameData.personnel.soldiers * (0.8 + (gameData.personnelLoyalty / 100) * 0.7);
    let enemyPower = enemySoldiers * (enemy ? enemy.powerLevel : 1);

    // Lose some soldiers in the fight
    let playerLosses = Math.min(gameData.personnel.soldiers, Math.ceil(enemyPower / 4));
    let enemyLosses = enemy ? Math.min(enemy.soldiers, Math.ceil(playerPower / 4)) : 0;

    gameData.personnel.soldiers -= playerLosses;
    if (enemy) enemy.soldiers -= enemyLosses;
    
    if (playerPower > enemyPower) {
        territory.owner = 'Player';
        showNotification(`Conquered ${territory.name}! You lost ${playerLosses} soldiers.`, "lightgreen");
        if (enemy) enemy.relationship -= 40;
    } else {
        showNotification(`Attack on ${territory.name} failed! You lost ${playerLosses} soldiers.`, "red");
        gameData.heat += 20;
    }
}

// =================================================================================
// SECTION 5: AI & DIPLOMACY
// =================================================================================
function runAiTurns() {
    gameData.aiPlayers.forEach(ai => {
        ai.money += 100 * ai.powerLevel; // AI passive income
        // AI may try to expand
        if (Math.random() < 0.05) {
            let neutralTerritories = gameData.territories.filter(t => t.owner === 'Neutral');
            if (neutralTerritories.length > 0) {
                let target = neutralTerritories[Math.floor(Math.random() * neutralTerritories.length)];
                if (ai.soldiers > 1) { // AI needs at least 2 soldiers to expand
                    target.owner = ai.id;
                    showNotification(`${ai.name} has taken control of ${target.name}!`, "orange");
                }
            }
        }
    });
}

function proposeDeal(aiIndex) { /* unchanged from previous version */ }

// =================================================================================
// SECTION 6: UI RENDERING
// =================================================================================
function showTab(tabName, event) {
    currentActiveTab = tabName;
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    document.getElementById(tabName).style.display = 'block';
    if(event) event.currentTarget.classList.add('active');
}

function updateUI() {
    if (!gameData || gameData.gameOver) return;
    
    document.getElementById('top-stats').innerHTML = `<p>💰 Dirty: $${Math.floor(gameData.money)}</p> <p>💵 Clean: $${Math.floor(gameData.whiteMoney)}</p> <p>🔥 Heat: ${Math.floor(gameData.heat)}</p>`;
    
    document.getElementById('operations').innerHTML = `<h2>Operations</h2> <div class="item-list"> <p><strong>Drug Operation</strong></p> <p>Producing: ${gameData.currentDrug}</p> <p>Stash: ${Math.floor(gameData.drugs)} units</p> <button onclick="handleButtonClick(upgradeLab)">Upgrade Lab</button> <hr> <p><strong>Arms Trafficking</strong></p> <p>Not implemented in this version</p> </div>`;
    
    document.getElementById('center-panel').innerHTML = `<div class="tab-buttons"> <button class="tab-link" onclick="showTab('map-panel', event)">Map</button> <button class="tab-link" onclick="showTab('diplomacy-panel', event)">Diplomacy</button> </div> <div id="map-panel" class="tab-content"></div> <div id="diplomacy-panel" class="tab-content item-list"></div>`;
    
    let loyaltyColor = gameData.personnelLoyalty > 60 ? 'lightgreen' : gameData.personnelLoyalty > 30 ? 'orange' : 'red';
    document.getElementById('personnel').innerHTML = `<h2>Personnel</h2> <div class="item-list"> <p><strong>Crew Morale: <span style="color:${loyaltyColor};">${gameData.personnelLoyalty.toFixed(1)}%</span></strong></p> <p>Next Payroll: ${gameData.payrollDue}s</p> <hr> <p>Producers: ${gameData.personnel.producers}</p> <button onclick="handleButtonClick(hirePersonnel, 'producer')">Hire Producer ($200)</button> <hr> <p>Dealers: ${gameData.personnel.dealers}</p> <button onclick="handleButtonClick(hirePersonnel, 'dealer')">Hire Dealer ($500)</button> <hr> <p>Soldiers: ${gameData.personnel.soldiers}</p> <button onclick="handleButtonClick(hirePersonnel, 'soldier')">Hire Soldier ($1000)</button> </div>`;
    
    // --- Populate Tabs ---
    let mapHTML = `<h2>City Map</h2><div id="map-grid">`;
    const ownerColors = {'Player': 'player', 'AI-1': 'ai-1', 'AI-2': 'ai-2', 'AI-3': 'ai-3', 'Neutral': 'neutral'};
    gameData.territories.forEach(t => {
        mapHTML += `<div class="territory ${ownerColors[t.owner]}-controlled" onclick="handleButtonClick(attackTerritory, ${t.id})"> ${t.name}<br>Value: ${t.value} </div>`;
    });
    mapHTML += `</div>`;
    document.getElementById('map-panel').innerHTML = mapHTML;

    let diplomacyHTML = ``; gameData.aiPlayers.forEach((ai, index) => { let relPercent = (ai.relationship + 100) / 2; diplomacyHTML += `<div class="list-item"> <strong>${ai.name}</strong> (Pwr: ${ai.powerLevel.toFixed(1)}) <div class="relationship-bar" style="width:100%;height:8px;background:#333;border:1px solid #0f0;margin-top:5px;"><div style="width:${relPercent}%;height:100%;background:#0f0;"></div></div> <button onclick="handleButtonClick(proposeDeal, ${index})">Deal ($10k)</button> </div>`; });
    document.getElementById('diplomacy-panel').innerHTML = diplomacyHTML;

    // Set active tab
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    document.getElementById(currentActiveTab).style.display = 'block';
    const activeLink = document.querySelector(`.tab-link[onclick="showTab('${currentActiveTab}', event)"]`);
    if(activeLink) activeLink.classList.add('active');
}

// =================================================================================
// SECTION 7: UTILITIES
// =================================================================================
function triggerGameOver(message) { gameData.gameOver = true; clearInterval(gameLoopInterval); document.getElementById('gameOverText').textContent = message; document.getElementById('gameOverScreen').style.display = 'flex'; }
function showNotification(msg, color = "#0f0") { const n = document.createElement("div"); n.textContent = msg; n.style.color = "black"; n.style.background = color; n.style.padding = "5px 10px"; n.style.borderRadius = "5px"; n.style.marginTop = "5px"; document.getElementById('notifications').appendChild(n); setTimeout(() => n.remove(), 4000); }
</script>
</body>
</html>
